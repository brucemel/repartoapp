<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App de Reparto - Prototipo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .screen:not(.active) { display: none !important; }
        .nav-btn { transition: all 0.2s; }
        .nav-btn:hover { background-color: #3b82f6; }
        .client-card { transition: transform 0.2s; }
        .client-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .map-mock { background: linear-gradient(180deg, #e0f2fe 0%, #bae6fd 100%); position: relative; overflow: hidden; }
        .pin { position: absolute; font-size: 24px; cursor: pointer; transition: transform 0.2s; }
        .pin:hover { transform: scale(1.2); }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">

<!-- PANTALLA 0: BIENVENIDA -->
<div id="welcome-screen" class="screen active min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-blue-700 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <div class="text-center mb-8">
            <div class="w-24 h-24 bg-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">App de Reparto</h1>
            <p class="text-gray-600">Gesti√≥n inteligente de entregas y clientes</p>
        </div>
        
        <div class="space-y-4">
            <!-- Iniciar Sesi√≥n -->
            <button onclick="showScreen('login-screen')" class="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-lg flex items-center justify-center gap-3">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                </svg>
                Iniciar Sesi√≥n
            </button>
            
            <!-- Crear Cuenta -->
            <button onclick="showScreen('create-account-screen')" class="w-full bg-white text-blue-600 py-4 rounded-lg font-semibold border-2 border-blue-600 hover:bg-blue-50 transition-colors shadow-lg flex items-center justify-center gap-3">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                </svg>
                Crear Cuenta
            </button>
        </div>
        
        <div class="mt-8 pt-6 border-t border-gray-200 text-center">
            <p class="text-sm text-gray-600 mb-2">¬øNecesitas ayuda?</p>
            <a href="#" class="text-sm text-blue-600 hover:underline font-medium">Contactar soporte</a>
        </div>
    </div>
</div>

<!-- PANTALLA 0.5: SELECCIONAR TIPO DE CUENTA -->
<div id="create-account-screen" class="screen min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-blue-700 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-4xl">
        <div class="text-center mb-8">
            <button onclick="showScreen('welcome-screen')" class="absolute top-8 left-8 text-white hover:text-gray-200">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Crear Cuenta</h1>
            <p class="text-gray-600">Selecciona el tipo de cuenta que deseas crear</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Cuenta Jefe -->
            <div onclick="openRegisterForm('jefe')" class="group cursor-pointer bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200 rounded-xl p-6 hover:border-purple-500 hover:shadow-xl transition-all">
                <div class="flex flex-col items-center text-center">
                    <div class="w-20 h-20 bg-purple-500 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">üëî Jefe / Administrador</h3>
                    <p class="text-sm text-gray-600 mb-4">Control total del sistema, gesti√≥n de usuarios y acceso a todas las funcionalidades de la aplicaci√≥n.</p>
                    <div class="mt-4 px-6 py-3 bg-purple-500 text-white rounded-lg font-semibold group-hover:bg-purple-600 transition-colors">
                        Crear cuenta de Jefe
                    </div>
                </div>
            </div>
            
            <!-- Cuenta Repartidor -->
            <div onclick="openRegisterForm('repartidor')" class="group cursor-pointer bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl p-6 hover:border-blue-500 hover:shadow-xl transition-all">
                <div class="flex flex-col items-center text-center">
                    <div class="w-20 h-20 bg-blue-500 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">üöö Repartidor</h3>
                    <p class="text-sm text-gray-600 mb-4">Personal encargado de realizar las entregas, gestionar clientes y registrar entregas en campo.</p>
                    <div class="mt-4 px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold group-hover:bg-blue-600 transition-colors">
                        Crear cuenta de Repartidor
                    </div>
                </div>
            </div>
            
            <!-- Cuenta Vendedor -->
            <div onclick="openRegisterForm('vendedor')" class="group cursor-pointer bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-200 rounded-xl p-6 hover:border-green-500 hover:shadow-xl transition-all">
                <div class="flex flex-col items-center text-center">
                    <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">üíº Vendedor</h3>
                    <p class="text-sm text-gray-600 mb-4">Personal de ventas enfocado en la gesti√≥n de clientes y consulta de informaci√≥n comercial.</p>
                    <div class="mt-4 px-6 py-3 bg-green-500 text-white rounded-lg font-semibold group-hover:bg-green-600 transition-colors">
                        Crear cuenta de Vendedor
                    </div>
                </div>
            </div>
            
            <!-- Cuenta Log√≠stica -->
            <div onclick="openRegisterForm('contabilidad')" class="group cursor-pointer bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl p-6 hover:border-orange-500 hover:shadow-xl transition-all">
                <div class="flex flex-col items-center text-center">
                    <div class="w-20 h-20 bg-orange-500 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">üìä Contabilidad y Log√≠stica</h3>
                    <p class="text-sm text-gray-600 mb-4">Personal administrativo con acceso a reportes financieros, estad√≠sticas y datos log√≠sticos.</p>
                    <div class="mt-4 px-6 py-3 bg-orange-500 text-white rounded-lg font-semibold group-hover:bg-orange-600 transition-colors">
                        Crear cuenta de Contabilidad
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
                ¬øYa tienes una cuenta? 
                <button onclick="showScreen('login-screen')" class="text-blue-600 hover:underline font-medium">Inicia sesi√≥n aqu√≠</button>
            </p>
        </div>
    </div>
</div>

<!-- PANTALLA 0.6: FORMULARIO DE REGISTRO -->
<div id="register-form-screen" class="screen min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-blue-700 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="mb-6">
            <button onclick="showScreen('create-account-screen')" class="text-gray-600 hover:text-gray-800 mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Crear Cuenta de <span id="register-role-name" class="text-blue-600"></span></h1>
            <p class="text-gray-600 text-sm">Completa tus datos para registrarte</p>
        </div>
        
        <form onsubmit="handleRegister(event)" class="space-y-4">
            <!-- Datos de la Empresa (solo para Jefe) -->
            <div id="company-section" class="hidden space-y-4 pb-4 mb-4 border-b">
                <h3 class="font-semibold text-gray-700">üìã Datos de la Empresa</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Empresa *</label>
                    <input type="text" id="company-name" placeholder="Ej: Transportes R√°pidos SAC" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">RUC *</label>
                    <input type="text" id="company-ruc" placeholder="20123456789" maxlength="11" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>

            <!-- Unirse a Empresa (para Repartidor, Vendedor, Contabilidad) -->
            <div id="join-company-section" class="hidden space-y-4 pb-4 mb-4 border-b">
                <h3 class="font-semibold text-gray-700">üè¢ Empresa</h3>
                <p class="text-sm text-gray-600 mb-3">Selecciona c√≥mo deseas asociarte a una empresa</p>
                
                <div class="space-y-3">
                    <!-- Opci√≥n 1: Tengo RUC -->
                    <label class="flex items-start p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 border-2 border-transparent has-[:checked]:border-blue-500">
                        <input type="radio" name="join-method" value="ruc" class="mt-1 w-4 h-4 text-blue-600" onchange="toggleJoinMethod('ruc')">
                        <div class="ml-3 flex-1">
                            <p class="font-medium text-gray-800">Tengo el RUC de la empresa</p>
                            <p class="text-sm text-gray-600">Ingresa el RUC para solicitar acceso</p>
                        </div>
                    </label>

                    <div id="ruc-input-section" class="hidden ml-7 mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">RUC de la Empresa</label>
                        <input type="text" id="join-company-ruc" placeholder="20123456789" maxlength="11" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Tu solicitud ser√° enviada al administrador</p>
                    </div>

                    <!-- Opci√≥n 2: Me van a invitar -->
                    <label class="flex items-start p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 border-2 border-transparent has-[:checked]:border-blue-500">
                        <input type="radio" name="join-method" value="invite" class="mt-1 w-4 h-4 text-blue-600" onchange="toggleJoinMethod('invite')" checked>
                        <div class="ml-3 flex-1">
                            <p class="font-medium text-gray-800">Esperar√© una invitaci√≥n</p>
                            <p class="text-sm text-gray-600">El administrador me agregar√° a la empresa</p>
                        </div>
                    </label>

                    <div id="invite-info-section" class="ml-7 mt-2 bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-xs text-blue-800">
                                Una vez registrado, el administrador de tu empresa podr√° agregarte usando tu email. Recibir√°s una notificaci√≥n cuando seas agregado.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Datos Personales -->
            <div class="space-y-4">
                <h3 class="font-semibold text-gray-700">üë§ Datos Personales</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                    <input type="text" id="register-fullname" placeholder="Juan P√©rez Garc√≠a" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">DNI *</label>
                    <input type="text" id="register-dni" placeholder="12345678" maxlength="8" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono / Celular *</label>
                    <input type="tel" id="register-phone" placeholder="987654321" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div id="whatsapp-section">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        üì± WhatsApp para Notificaciones *
                        <span class="text-xs text-gray-500 font-normal">(Con c√≥digo de pa√≠s)</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 text-gray-500">+</span>
                        <input 
                            type="tel" 
                            id="register-whatsapp" 
                            placeholder="51923190308" 
                            required 
                            class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            oninput="formatWhatsAppNumber(this)"
                        >
                    </div>
                    <p class="mt-1 text-xs text-gray-500">
                        üí° Este n√∫mero recibir√° las notificaciones de entregas
                    </p>
                    <p class="mt-1 text-xs text-blue-600">
                        Ejemplo: 51923190308 (Per√∫), 5215512345678 (M√©xico)
                    </p>
                </div>
            </div>
            
            <!-- Datos de Acceso -->
            <div class="space-y-4 pt-4 border-t">
                <h3 class="font-semibold text-gray-700">üîê Datos de Acceso</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="register-email" placeholder="usuario@empresa.com" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a *</label>
                    <input type="password" id="register-password" placeholder="M√≠nimo 8 caracteres" minlength="8" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Contrase√±a *</label>
                    <input type="password" id="register-password-confirm" placeholder="Repite tu contrase√±a" minlength="8" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            
            <!-- T√©rminos y Condiciones -->
            <div class="pt-4">
                <label class="flex items-start gap-3">
                    <input type="checkbox" required class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-sm text-gray-700">
                        Acepto los <a href="#" class="text-blue-600 hover:underline">t√©rminos y condiciones</a> y la 
                        <a href="#" class="text-blue-600 hover:underline">pol√≠tica de privacidad</a>
                    </span>
                </label>
            </div>
            
            <!-- Botones -->
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="showScreen('create-account-screen')" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
                    Crear Cuenta
                </button>
            </div>
        </form>
    </div>
</div>

<!-- PANTALLA 1: LOGIN -->
<div id="login-screen" class="screen min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-blue-700 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <div class="mb-6">
            <button onclick="showScreen('welcome-screen')" class="text-gray-600 hover:text-gray-800 mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
        </div>
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Iniciar Sesi√≥n</h1>
            <p class="text-gray-600">Ingresa a tu cuenta</p>
        </div>
        
        <div class="space-y-4">
            <!-- Role Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usuario</label>
                <select id="user-role" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="jefe" selected>üëî Jefe / Administrador</option>
                    <option value="repartidor">üöö Repartidor</option>
                    <option value="vendedor">üíº Vendedor</option>
                    <option value="contabilidad">üìä Contabilidad y Log√≠stica</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="login-email" value="jefe@empresa.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                <input type="password" id="login-password" value="123456" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <!-- Quick Login Buttons -->
            <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4">
                <p class="text-xs font-semibold text-green-800 mb-3 text-center">
                    üöÄ ACCESO R√ÅPIDO DEMO
                </p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="quickLogin('jefe')" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-semibold hover:bg-purple-700 transition-colors">
                        üëî Jefe
                    </button>
                    <button onclick="quickLogin('repartidor')" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700 transition-colors">
                        üöö Repartidor
                    </button>
                    <button onclick="quickLogin('vendedor')" class="px-3 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition-colors">
                        üíº Vendedor
                    </button>
                    <button onclick="quickLogin('contabilidad')" class="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-semibold hover:bg-orange-700 transition-colors">
                        üìä Contabilidad
                    </button>
                </div>
                <p class="text-xs text-green-700 mt-2 text-center">
                    O simplemente presiona "Ingresar" ‚¨áÔ∏è
                </p>
            </div>
            
            <!-- Security Notice -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <p class="text-xs text-blue-800">
                        <strong>Sesi√≥n √∫nica:</strong> Si inicias sesi√≥n en otro dispositivo, se cerrar√° autom√°ticamente tu sesi√≥n actual.
                    </p>
                </div>
            </div>
            
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                Ingresar
            </button>
            <a href="#" class="block text-center text-sm text-blue-600 hover:underline mt-3">¬øOlvidaste tu contrase√±a?</a>
        </div>
        
        <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
                ¬øNo tienes cuenta? 
                <button onclick="showScreen('create-account-screen')" class="text-blue-600 hover:underline font-medium">Reg√≠strate aqu√≠</button>
            </p>
        </div>
        
        <!-- Bot√≥n de debug para resetear datos -->
        <div class="mt-4 text-center">
            <button onclick="resetDemoData()" class="text-xs text-gray-500 hover:text-gray-700 underline">
                üîß Resetear datos demo (si no puedes entrar)
            </button>
        </div>
        
        <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
            <p>Plan B√°sico: 7/10 clientes</p>
        </div>
    </div>
</div>

<!-- PANTALLA 2: DASHBOARD -->
<div id="dashboard-screen" class="screen min-h-screen">
    <!-- Header -->
    <div class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold">Dashboard</h1>
                <p class="text-blue-100 text-sm">Bienvenido, Repartidor</p>
            </div>
            <div class="flex items-center gap-3">
                <!-- Notifications Bell -->
                <button onclick="showScreen('notifications-screen')" class="relative p-2 hover:bg-blue-700 rounded-lg transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <!-- Badge with notification count -->
                    <span id="notification-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold">3</span>
                </button>
                <button onclick="showScreen('login-screen')" class="px-4 py-2 bg-blue-700 rounded-lg hover:bg-blue-800">
                    Salir
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="max-w-7xl mx-auto p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Total Clientes</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">7</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: 70%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Plan B√°sico: 7/10 clientes</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Mercados</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">3</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-4">Central, Gamarra, Mesa Redonda</p>
            </div>

        </div>

        <!-- Actions -->
        <div class="bg-white rounded-xl shadow p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Acciones R√°pidas</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <button onclick="showScreen('delivery-screen')" class="flex flex-col items-center p-4 bg-orange-50 rounded-lg hover:bg-orange-100 transition-colors">
                    <svg class="w-8 h-8 text-orange-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <span class="text-sm font-medium text-gray-700">Programar Reparto</span>
                </button>
                
                <button onclick="showScreen('list-screen')" class="flex flex-col items-center p-4 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
                    <svg class="w-8 h-8 text-green-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <span class="text-sm font-medium text-gray-700">Lista de Clientes</span>
                </button>
                
                <button onclick="showScreen('map-screen')" class="flex flex-col items-center p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition-colors">
                    <svg class="w-8 h-8 text-purple-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    <span class="text-sm font-medium text-gray-700">Ver Mapa</span>
                </button>
                
                <button onclick="showScreen('accounts-receivable-screen')" class="flex flex-col items-center p-4 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">
                    <svg class="w-8 h-8 text-red-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm font-medium text-gray-700">Cuentas por Cobrar</span>
                </button>

                <button onclick="sendDailySummary()" class="flex flex-col items-center p-4 bg-yellow-50 rounded-lg hover:bg-yellow-100 transition-colors">
                    <svg class="w-8 h-8 text-yellow-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="text-sm font-medium text-gray-700">Resumen Diario</span>
                </button>
            </div>
        </div>

        <!-- Admin Panel Access (Only for Jefe) -->
        <div id="access-control-btn" class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 mb-6" style="display: none;">
            <div class="flex items-center justify-between text-white">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg">Panel de Control de Accesos</h3>
                        <p class="text-purple-100 text-sm">Gestiona usuarios, sesiones y permisos</p>
                    </div>
                </div>
                <button onclick="showScreen('access-control-screen')" class="px-6 py-3 bg-white text-purple-600 rounded-lg font-semibold hover:bg-purple-50 transition-colors">
                    Abrir Panel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PANTALLA 3: NOTIFICACIONES -->
<div id="notifications-screen" class="screen min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <button onclick="showScreen('dashboard-screen')" class="text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="text-center flex-1">
                <h1 class="text-2xl font-bold">Notificaciones</h1>
                <p class="text-blue-100 text-sm">Alertas del sistema</p>
            </div>
            <button onclick="clearAllNotifications()" class="text-white text-sm hover:underline">
                Limpiar
            </button>
        </div>
    </div>

    <!-- Notification Stats -->
    <div class="max-w-3xl mx-auto p-4">
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-2xl font-bold text-blue-600" id="unread-count">3</p>
                <p class="text-xs text-gray-600 mt-1">Sin leer</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-2xl font-bold text-gray-600">5</p>
                <p class="text-xs text-gray-600 mt-1">Total hoy</p>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="bg-white rounded-lg shadow p-3 mb-4">
            <div class="flex gap-2">
                <button class="flex-1 py-2 px-3 bg-blue-600 text-white rounded-lg text-sm font-medium">
                    Todas
                </button>
                <button class="flex-1 py-2 px-3 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                    Entregas
                </button>
                <button class="flex-1 py-2 px-3 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                    Sistema
                </button>
            </div>
        </div>

        <!-- Notifications List -->
        <div class="space-y-3" id="notifications-list">
            <!-- Notificaci√≥n nueva - Entrega completada -->
            <div class="notification-item bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow p-4 cursor-pointer hover:bg-blue-100 transition-colors">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-start justify-between mb-1">
                            <h3 class="font-bold text-gray-800">Entrega Completada</h3>
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                        </div>
                        <p class="text-sm text-gray-700 mb-1">
                            <strong>Juan Rodr√≠guez</strong> - Mercado Central
                        </p>
                        <p class="text-xs text-gray-600">
                            Entregado por: Repartidor 1
                        </p>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-xs text-gray-500">Hace 5 minutos</span>
                            <span class="text-xs text-gray-400">‚Ä¢</span>
                            <span class="text-xs text-green-600 font-medium">‚úì Completado</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notificaci√≥n nueva - Entrega completada 2 -->
            <div class="notification-item bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow p-4 cursor-pointer hover:bg-blue-100 transition-colors">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-start justify-between mb-1">
                            <h3 class="font-bold text-gray-800">Entrega Completada</h3>
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                        </div>
                        <p class="text-sm text-gray-700 mb-1">
                            <strong>Mar√≠a Garc√≠a</strong> - Gamarra
                        </p>
                        <p class="text-xs text-gray-600">
                            Entregado por: Repartidor 1
                        </p>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-xs text-gray-500">Hace 15 minutos</span>
                            <span class="text-xs text-gray-400">‚Ä¢</span>
                            <span class="text-xs text-green-600 font-medium">‚úì Completado</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notificaci√≥n nueva - Cliente agregado -->
            <div class="notification-item bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow p-4 cursor-pointer hover:bg-blue-100 transition-colors">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-start justify-between mb-1">
                            <h3 class="font-bold text-gray-800">Nuevo Cliente</h3>
                            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                        </div>
                        <p class="text-sm text-gray-700 mb-1">
                            <strong>Carlos L√≥pez</strong> agregado a tu lista
                        </p>
                        <p class="text-xs text-gray-600">
                            Zona: Mesa Redonda
                        </p>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-xs text-gray-500">Hace 1 hora</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notificaci√≥n le√≠da - Entrega completada anterior -->
            <div class="notification-item bg-white border-l-4 border-gray-300 rounded-lg shadow p-4 cursor-pointer hover:bg-gray-50 transition-colors">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div class="flex-1 opacity-75">
                        <div class="flex items-start justify-between mb-1">
                            <h3 class="font-semibold text-gray-700">Entrega Completada</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">
                            <strong>Ana Mart√≠nez</strong> - Mercado Central
                        </p>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-xs text-gray-500">Hace 2 horas</span>
                            <span class="text-xs text-gray-400">‚Ä¢</span>
                            <span class="text-xs text-green-600">‚úì Completado</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notificaci√≥n le√≠da - Entrega completada anterior 2 -->
            <div class="notification-item bg-white border-l-4 border-gray-300 rounded-lg shadow p-4 cursor-pointer hover:bg-gray-50 transition-colors">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div class="flex-1 opacity-75">
                        <div class="flex items-start justify-between mb-1">
                            <h3 class="font-semibold text-gray-700">Entrega Completada</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">
                            <strong>Pedro S√°nchez</strong> - Gamarra
                        </p>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="text-xs text-gray-500">Hace 3 horas</span>
                            <span class="text-xs text-gray-400">‚Ä¢</span>
                            <span class="text-xs text-green-600">‚úì Completado</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State (hidden when there are notifications) -->
        <div id="empty-notifications-state" class="hidden bg-white rounded-lg shadow p-12 text-center">
            <svg class="w-20 h-20 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
            </svg>
            <h3 class="text-xl font-bold text-gray-800 mb-2">No hay notificaciones</h3>
            <p class="text-gray-600">Cuando haya actividad, aparecer√° aqu√≠</p>
        </div>
    </div>
</div>

<!-- PANTALLA 4: LISTA DE CLIENTES -->
<div id="list-screen" class="screen min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto p-4">
            <div class="flex items-center justify-between mb-4">
                <button onclick="showScreen('dashboard-screen')" class="text-blue-600 hover:text-blue-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-gray-800">Clientes</h1>
                <button onclick="showScreen('add-client-screen')" class="text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Search and Filter -->
            <div class="flex gap-2">
                <input type="text" id="search-clients" placeholder="Buscar por nombre, DNI o mercado..." oninput="filterClientsList()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Add Client Button -->
            <div class="mt-3">
                <button onclick="showScreen('add-client-screen')" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                    ‚ûï Agregar Nuevo Cliente
                </button>
            </div>
            
            <!-- View Toggle -->
            <div class="flex gap-2 mt-3">
                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium">Por Lista</button>
                <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">Por Mercados</button>
            </div>
        </div>
    </div>

    <!-- Clients List -->
    <div class="max-w-7xl mx-auto p-4 space-y-3">
        <div onclick="showScreen('detail-screen')" class="client-card bg-white rounded-lg shadow p-4 cursor-pointer" data-name="Juan Rodr√≠guez" data-dni="12345678" data-zone="Mercado Central">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-blue-600 font-bold text-lg">JR</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800">Juan Rodr√≠guez</h3>
                        <p class="text-sm text-gray-600">DNI: 12345678</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">Mercado Central</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center hover:bg-green-200">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                    </button>
                    <button class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center hover:bg-orange-200">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div onclick="showScreen('detail-screen')" class="client-card bg-white rounded-lg shadow p-4 cursor-pointer" data-name="Mar√≠a Garc√≠a" data-dni="87654321" data-zone="Gamarra">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <span class="text-green-600 font-bold text-lg">MG</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800">Mar√≠a Garc√≠a</h3>
                        <p class="text-sm text-gray-600">DNI: 87654321</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">Gamarra</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center hover:bg-green-200">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                    </button>
                    <button class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center hover:bg-orange-200">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div onclick="showScreen('detail-screen')" class="client-card bg-white rounded-lg shadow p-4 cursor-pointer" data-name="Carlos L√≥pez" data-dni="45678912" data-zone="Mesa Redonda">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <span class="text-purple-600 font-bold text-lg">CL</span>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-800">Carlos L√≥pez</h3>
                        <p class="text-sm text-gray-600">DNI: 45678912</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">Mesa Redonda</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center hover:bg-green-200">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                    </button>
                    <button class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center hover:bg-orange-200">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Export Button (small, at end of list) -->
        <div class="pb-20">
            <button onclick="exportClientsToExcel()" class="w-full px-3 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-green-100 hover:text-green-700 transition-colors flex items-center justify-center gap-2 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Exportar a Excel
            </button>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-around">
            <button onclick="showScreen('dashboard-screen')" class="flex flex-col items-center text-gray-600 hover:text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-xs mt-1">Inicio</span>
            </button>
            <button class="flex flex-col items-center text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
                <span class="text-xs mt-1">Lista</span>
            </button>
            <button onclick="showScreen('map-screen')" class="flex flex-col items-center text-gray-600 hover:text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                </svg>
                <span class="text-xs mt-1">Mapa</span>
            </button>
        </div>
    </div>
</div>

<!-- PANTALLA 5: MAPA -->
<div id="map-screen" class="screen min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto p-4 flex items-center justify-between">
            <button onclick="showScreen('dashboard-screen')" class="text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h1 class="text-xl font-bold text-gray-800">Mapa de Clientes</h1>
            <div class="w-6"></div>
        </div>
    </div>

    <!-- Map -->
    <div class="relative">
        <div class="map-mock h-[calc(100vh-180px)]">
            <!-- Pins simulados -->
            <div class="pin" style="left: 30%; top: 25%;" title="Juan Rodr√≠guez">üìç</div>
            <div class="pin" style="left: 45%; top: 40%;" title="Mar√≠a Garc√≠a">üìç</div>
            <div class="pin" style="left: 60%; top: 30%;" title="Carlos L√≥pez">üìç</div>
            <div class="pin" style="left: 35%; top: 60%;" title="Ana Mart√≠nez">üìç</div>
            <div class="pin" style="left: 70%; top: 55%;" title="Pedro S√°nchez">üìç</div>
            
            <!-- Texto simulado de Google Maps -->
            <div class="absolute top-4 left-4 bg-white rounded-lg shadow px-3 py-2 text-sm text-gray-600">
                Lima, Per√∫
            </div>
        </div>

        <!-- Legend -->
        <div class="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg p-4">
            <h3 class="font-semibold text-gray-800 mb-2 text-sm">Zonas</h3>
            <div class="space-y-1 text-sm">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    <span class="text-gray-700">Mercado Central (3)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="text-gray-700">Gamarra (2)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                    <span class="text-gray-700">Mesa Redonda (2)</span>
                </div>
            </div>
        </div>

        <!-- Zoom controls -->
        <div class="absolute top-4 right-4 bg-white rounded-lg shadow-lg">
            <button class="block px-4 py-2 hover:bg-gray-100 border-b">+</button>
            <button class="block px-4 py-2 hover:bg-gray-100">‚àí</button>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-around">
            <button onclick="showScreen('dashboard-screen')" class="flex flex-col items-center text-gray-600 hover:text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="text-xs mt-1">Inicio</span>
            </button>
            <button onclick="showScreen('list-screen')" class="flex flex-col items-center text-gray-600 hover:text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
                <span class="text-xs mt-1">Lista</span>
            </button>
            <button class="flex flex-col items-center text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                </svg>
                <span class="text-xs mt-1">Mapa</span>
            </button>
        </div>
    </div>
</div>

<!-- PANTALLA 6: AGREGAR CLIENTE -->
<div id="add-client-screen" class="screen min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-3xl mx-auto p-4 flex items-center justify-between">
            <button onclick="showScreen('dashboard-screen')" class="text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <h1 class="text-xl font-bold text-gray-800">Agregar Cliente</h1>
            <div class="w-6"></div>
        </div>
    </div>

    <!-- Form -->
    <div class="max-w-3xl mx-auto p-4 pb-24">
        <div class="bg-white rounded-xl shadow p-6 space-y-4">
            <!-- DNI -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">DNI *</label>
                <input id="client-dni" type="text" placeholder="Ejemplo: 12345678" maxlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>

            <!-- Nombre -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                <input id="client-name" type="text" placeholder="Ejemplo: Juan P√©rez Garc√≠a" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>

            <!-- Tel√©fonos -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fonos</label>
                <div class="space-y-2">
                    <div class="flex gap-2">
                        <input id="client-phone" type="tel" placeholder="Celular: 987654321" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button class="px-4 py-3 bg-green-100 text-green-600 rounded-lg hover:bg-green-200">
                            ‚≠ê Principal
                        </button>
                    </div>
                    <button class="text-blue-600 text-sm font-medium hover:underline">+ Agregar tel√©fono</button>
                </div>
            </div>

            <!-- Zona/Mercado -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Zona/Mercado</label>
                <select id="client-zone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option>Selecciona una zona</option>
                    <option>Mercado Central</option>
                    <option>Gamarra</option>
                    <option>Mesa Redonda</option>
                    <option>Villa El Salvador</option>
                    <option>San Juan de Lurigancho</option>
                    <option>Cercado de Lima</option>
                    <option>Callao</option>
                    <option>La Victoria</option>
                    <option>San Borja</option>
                    <option>Surco</option>
                    <option>Los Olivos</option>
                    <option>Otro / Individual</option>
                </select>
            </div>

            <!-- Direcciones -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Direcciones</label>
                <div class="space-y-3">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Negocio</span>
                            <button class="px-3 py-1 bg-green-100 text-green-600 text-xs rounded hover:bg-green-200">
                                ‚≠ê Principal
                            </button>
                        </div>
                        
                        <input type="text" placeholder="Direcci√≥n completa" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 text-sm">
                        <input type="text" placeholder="Referencia (ej: Al lado de la farmacia)" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-3 text-sm">
                        
                        <!-- Opciones de ubicaci√≥n -->
                        <div class="space-y-2">
                            <p class="text-xs font-medium text-gray-600 mb-2">Ubicaci√≥n en mapa:</p>
                            
                            <!-- Bot√≥n capturar ubicaci√≥n GPS -->
                            <button onclick="captureLocation(this)" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span class="font-medium">Usar mi ubicaci√≥n actual (GPS)</span>
                            </button>
                            
                            <!-- Bot√≥n seleccionar en mapa -->
                            <button onclick="openMapPicker()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-white border-2 border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                                </svg>
                                <span class="font-medium">Seleccionar en el mapa</span>
                            </button>
                            
                            <!-- Indicador de ubicaci√≥n capturada -->
                            <div id="location-indicator" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-green-800">Ubicaci√≥n capturada</p>
                                        <p class="text-xs text-green-700 mt-1">Lat: <span id="lat-value">-12.0464</span>, Lng: <span id="lng-value">-77.0428</span></p>
                                        <p class="text-xs text-green-600 mt-1">Precisi√≥n: ¬±5 metros</p>
                                    </div>
                                    <button onclick="clearLocation()" class="text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="text-blue-600 text-sm font-medium hover:underline">+ Agregar direcci√≥n</button>
                </div>
            </div>

            <!-- Notas -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Notas adicionales (opcional)</label>
                <textarea placeholder="Informaci√≥n relevante sobre el cliente..." rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
            </div>
        </div>

        <!-- Alert de l√≠mite -->
        <div class="mt-4 bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-amber-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div>
                    <p class="text-sm font-medium text-amber-800">Atenci√≥n: L√≠mite de Plan</p>
                    <p class="text-sm text-amber-700 mt-1">Tienes 7/10 clientes. Te quedan 3 espacios disponibles en tu Plan B√°sico.</p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 flex gap-3">
            <button onclick="showScreen('list-screen')" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50">
                Cancelar
            </button>
            <button onclick="saveNewClient()" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
                Guardar Cliente
            </button>
        </div>
    </div>
</div>

<!-- PANTALLA 6: DETALLE CLIENTE -->
<div id="detail-screen" class="screen min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-3xl mx-auto p-4 flex items-center justify-between">
            <button onclick="showScreen('list-screen')" class="text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h1 class="text-xl font-bold text-gray-800">Detalle del Cliente</h1>
            <button class="text-blue-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Content -->
    <div class="max-w-3xl mx-auto p-4 space-y-4">
        <!-- Client Info -->
        <div class="bg-white rounded-xl shadow p-6">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                    <span class="text-blue-600 font-bold text-2xl">JR</span>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Juan Rodr√≠guez</h2>
                    <p class="text-gray-600">DNI: 12345678</p>
                    <span class="inline-block mt-2 px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded-full">Mercado Central</span>
                </div>
            </div>
        </div>

        <!-- Phones -->
        <div class="bg-white rounded-xl shadow p-6">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                Tel√©fonos
            </h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium text-gray-800">987 654 321</p>
                        <p class="text-sm text-gray-600">Celular ‚Ä¢ <span class="text-green-600">‚≠ê Principal</span></p>
                    </div>
                    <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Llamar
                    </button>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium text-gray-800">956 789 123</p>
                        <p class="text-sm text-gray-600">Trabajo</p>
                    </div>
                    <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Llamar
                    </button>
                </div>
            </div>
        </div>

        <!-- Addresses -->
        <div class="bg-white rounded-xl shadow p-6">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                </svg>
                Direcciones
            </h3>
            <div class="space-y-3">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Negocio</span>
                            <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded ml-2">‚≠ê Principal</span>
                        </div>
                    </div>
                    <p class="font-medium text-gray-800 mb-1">Jr. Ayacucho 567, Mercado Central</p>
                    <p class="text-sm text-gray-600 mb-3">Ref: Puesto 234, frente a la entrada principal</p>
                    <button class="w-full py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                        </svg>
                        Navegar con Google Maps
                    </button>
                </div>

                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="mb-2">
                        <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Casa</span>
                    </div>
                    <p class="font-medium text-gray-800 mb-1">Av. Brasil 1234, Bre√±a</p>
                    <p class="text-sm text-gray-600 mb-3">Ref: Edificio azul, tercer piso</p>
                    <button class="w-full py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                        </svg>
                        Navegar con Google Maps
                    </button>
                </div>
            </div>
        </div>

        <!-- Delivery History -->
        <div class="bg-white rounded-xl shadow p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    Historial de Entregas
                </h3>
                <span class="text-sm text-gray-600">3 entregas</span>
            </div>
            
            <div id="client-delivery-history" class="space-y-3">
                <!-- Delivery 1 - Recent -->
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-semibold text-gray-700">Gu√≠a: GU-2024-00345</span>
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">
                                    Pagado Completo
                                </span>
                            </div>
                            <p class="text-xs text-gray-500">Hace 3 d√≠as - 09/12/2024, 14:30</p>
                        </div>
                        <button onclick="toggleDeliveryDetails('delivery-1')" class="text-blue-600 hover:text-blue-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <p class="text-xs text-gray-500">Importe Total</p>
                            <p class="text-base font-bold text-gray-800">S/. 450.00</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">M√©todo de Pago</p>
                            <p class="text-sm font-medium text-gray-700">üíµ Efectivo</p>
                        </div>
                    </div>
                    
                    <!-- Detalles expandibles -->
                    <div id="delivery-1" class="hidden mt-3 pt-3 border-t border-gray-200 space-y-2">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <p class="text-xs text-gray-500">Tipo de Venta</p>
                                <p class="font-medium text-gray-700">Contado</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Repartidor</p>
                                <p class="font-medium text-gray-700">Repartidor 1</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Monto Pagado</p>
                                <p class="font-medium text-green-700">S/. 450.00</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Saldo Pendiente</p>
                                <p class="font-medium text-gray-700">S/. 0.00</p>
                            </div>
                        </div>
                        <div class="mt-2">
                            <p class="text-xs text-gray-500 mb-1">Observaciones</p>
                            <p class="text-sm text-gray-700 italic">Cliente satisfecho, entrega sin problemas</p>
                        </div>
                    </div>
                </div>

                <!-- Delivery 2 - With pending balance -->
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-semibold text-gray-700">Gu√≠a: GU-2024-00298</span>
                                <span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs font-medium rounded-full">
                                    Pago Parcial
                                </span>
                            </div>
                            <p class="text-xs text-gray-500">Hace 1 semana - 05/12/2024, 16:15</p>
                        </div>
                        <button onclick="toggleDeliveryDetails('delivery-2')" class="text-blue-600 hover:text-blue-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <p class="text-xs text-gray-500">Importe Total</p>
                            <p class="text-base font-bold text-gray-800">S/. 680.00</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">M√©todo de Pago</p>
                            <p class="text-sm font-medium text-gray-700">üì± Yape</p>
                        </div>
                    </div>
                    
                    <!-- Detalles expandibles -->
                    <div id="delivery-2" class="hidden mt-3 pt-3 border-t border-gray-200 space-y-2">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <p class="text-xs text-gray-500">Tipo de Venta</p>
                                <p class="font-medium text-gray-700">Cr√©dito</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Repartidor</p>
                                <p class="font-medium text-gray-700">Repartidor 1</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Monto Pagado</p>
                                <p class="font-medium text-green-700">S/. 400.00</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Saldo Pendiente</p>
                                <p class="font-medium text-amber-700">‚ö†Ô∏è S/. 280.00</p>
                            </div>
                        </div>
                        <div class="mt-2">
                            <p class="text-xs text-gray-500 mb-1">Observaciones</p>
                            <p class="text-sm text-gray-700 italic">Cliente pagar√° el saldo pendiente la pr√≥xima semana</p>
                        </div>
                        <div class="mt-3 bg-amber-50 border border-amber-200 rounded-lg p-3">
                            <p class="text-xs font-medium text-amber-800 mb-2">üí∞ Acci√≥n Requerida</p>
                            <button class="w-full py-2 bg-amber-600 text-white rounded-lg text-sm font-medium hover:bg-amber-700">
                                Registrar Pago de Saldo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Delivery 3 - Older -->
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-semibold text-gray-700">Gu√≠a: GU-2024-00187</span>
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">
                                    Pagado Completo
                                </span>
                            </div>
                            <p class="text-xs text-gray-500">Hace 2 semanas - 28/11/2024, 11:45</p>
                        </div>
                        <button onclick="toggleDeliveryDetails('delivery-3')" class="text-blue-600 hover:text-blue-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <p class="text-xs text-gray-500">Importe Total</p>
                            <p class="text-base font-bold text-gray-800">S/. 320.00</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">M√©todo de Pago</p>
                            <p class="text-sm font-medium text-gray-700">üí≥ Plin</p>
                        </div>
                    </div>
                    
                    <!-- Detalles expandibles -->
                    <div id="delivery-3" class="hidden mt-3 pt-3 border-t border-gray-200 space-y-2">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <p class="text-xs text-gray-500">Tipo de Venta</p>
                                <p class="font-medium text-gray-700">Contado</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Repartidor</p>
                                <p class="font-medium text-gray-700">Repartidor 1</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Monto Pagado</p>
                                <p class="font-medium text-green-700">S/. 320.00</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Saldo Pendiente</p>
                                <p class="font-medium text-gray-700">S/. 0.00</p>
                            </div>
                        </div>
                        <div class="mt-2">
                            <p class="text-xs text-gray-500 mb-1">Observaciones</p>
                            <p class="text-sm text-gray-700 italic">Primera entrega al cliente, todo en orden</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Resumen del Cliente</h4>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1">Total Vendido</p>
                        <p class="text-lg font-bold text-blue-600">S/. 1,450</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1">Cobrado</p>
                        <p class="text-lg font-bold text-green-600">S/. 1,170</p>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-3 text-center">
                        <p class="text-xs text-gray-600 mb-1">Pendiente</p>
                        <p class="text-lg font-bold text-amber-600">S/. 280</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 pb-6">
            <button onclick="showScreen('list-screen')" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
                Editar Cliente
            </button>
            <button class="px-6 py-3 border border-red-300 text-red-600 rounded-lg font-semibold hover:bg-red-50">
                Eliminar
            </button>
        </div>
    </div>
</div>

<!-- PANTALLA 8: PROGRAMAR REPARTO -->
<div id="delivery-screen" class="screen min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-orange-600 text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <button onclick="showScreen('dashboard-screen')" class="text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="text-center flex-1">
                <h1 class="text-2xl font-bold">Reparto</h1>
                <p class="text-orange-100 text-sm">Programa tus entregas del d√≠a</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="exportDeliveryReport()" class="text-white hover:bg-orange-700 p-2 rounded-lg" title="Exportar reporte del d√≠a">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </button>
                <button onclick="openAddToDelivery()" class="text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="max-w-7xl mx-auto p-4">
        <div class="grid grid-cols-3 gap-3 mb-4">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-2xl font-bold text-orange-600">5</p>
                <p class="text-xs text-gray-600 mt-1">Total Entregas</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-2xl font-bold text-red-600">2</p>
                <p class="text-xs text-gray-600 mt-1">üåü Prioritarias</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-2xl font-bold text-green-600">3</p>
                <p class="text-xs text-gray-600 mt-1">Normales</p>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="bg-white rounded-lg shadow p-3 mb-4">
            <div class="flex gap-2">
                <button class="flex-1 py-2 px-3 bg-orange-600 text-white rounded-lg text-sm font-medium">
                    Todas (5)
                </button>
                <button class="flex-1 py-2 px-3 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                    üåü Prioritarias (2)
                </button>
                <button class="flex-1 py-2 px-3 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200">
                    Normales (3)
                </button>
            </div>
        </div>

        <!-- Delivery List -->
        <div class="space-y-3">
            <!-- Prioritaria 1 -->
            <div class="bg-white rounded-lg shadow-md border-l-4 border-red-500">
                <div class="p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-blue-600 font-bold">JR</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="font-bold text-gray-800">Juan Rodr√≠guez</h3>
                                    <button onclick="togglePriority(this)" class="text-yellow-500 text-xl">‚≠ê</button>
                                </div>
                                <p class="text-sm text-gray-600">DNI: 12345678</p>
                                <span class="inline-block mt-1 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">Mercado Central</span>
                            </div>
                        </div>
                        <button onclick="removeFromDelivery(this)" class="text-red-500 hover:text-red-700 ml-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                            <span class="text-gray-700">987 654 321</span>
                            <button onclick="window.location.href='tel:987654321'" class="ml-auto px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                Llamar
                            </button>
                        </div>
                        <div class="flex items-start gap-2 text-sm">
                            <svg class="w-4 h-4 text-gray-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            </svg>
                            <span class="text-gray-700 flex-1">Jr. Ayacucho 567, Mercado Central</span>
                            <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=Jr.+Ayacucho+567+Mercado+Central+Lima', '_blank')" class="px-3 py-1 bg-orange-600 text-white rounded text-xs hover:bg-orange-700">
                                Navegar
                            </button>
                        </div>
                        <div class="text-xs text-gray-500 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Ref: Puesto 234, frente a la entrada principal
                        </div>
                    </div>

                    <div class="mt-3 flex gap-2">
                        <button onclick="markAsDelivered(this, 'Juan Rodr√≠guez', 'Mercado Central')" class="flex-1 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Marcar Entregado
                        </button>
                        <button class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200">
                            Detalles
                        </button>
                    </div>
                </div>
            </div>

            <!-- Prioritaria 2 -->
            <div class="bg-white rounded-lg shadow-md border-l-4 border-red-500">
                <div class="p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-purple-600 font-bold">CL</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="font-bold text-gray-800">Carlos L√≥pez</h3>
                                    <button onclick="togglePriority(this)" class="text-yellow-500 text-xl">‚≠ê</button>
                                </div>
                                <p class="text-sm text-gray-600">DNI: 45678912</p>
                                <span class="inline-block mt-1 px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">Mesa Redonda</span>
                            </div>
                        </div>
                        <button onclick="removeFromDelivery(this)" class="text-red-500 hover:text-red-700 ml-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                            <span class="text-gray-700">945 123 789</span>
                            <button onclick="window.location.href='tel:945123789'" class="ml-auto px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                Llamar
                            </button>
                        </div>
                        <div class="flex items-start gap-2 text-sm">
                            <svg class="w-4 h-4 text-gray-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            </svg>
                            <span class="text-gray-700 flex-1">Jr. Andahuaylas 789, Mesa Redonda</span>
                            <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=Jr.+Andahuaylas+789+Mesa+Redonda+Lima', '_blank')" class="px-3 py-1 bg-orange-600 text-white rounded text-xs hover:bg-orange-700">
                                Navegar
                            </button>
                        </div>
                    </div>

                    <div class="mt-3 flex gap-2">
                        <button onclick="markAsDelivered(this, 'Carlos L√≥pez', 'Mesa Redonda')" class="flex-1 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Marcar Entregado
                        </button>
                        <button onclick="showScreen('detail-screen')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200">
                            Detalles
                        </button>
                    </div>
                </div>
            </div>

            <!-- Normal 1 -->
            <div class="bg-white rounded-lg shadow border-l-4 border-gray-300">
                <div class="p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <span class="text-green-600 font-bold">MG</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="font-bold text-gray-800">Mar√≠a Garc√≠a</h3>
                                    <button onclick="togglePriority(this)" class="text-gray-300 text-xl hover:text-yellow-500">‚òÜ</button>
                                </div>
                                <p class="text-sm text-gray-600">DNI: 87654321</p>
                                <span class="inline-block mt-1 px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">Gamarra</span>
                            </div>
                        </div>
                        <button onclick="removeFromDelivery(this)" class="text-red-500 hover:text-red-700 ml-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                            <span class="text-gray-700">923 456 789</span>
                            <button onclick="window.location.href='tel:923456789'" class="ml-auto px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                Llamar
                            </button>
                        </div>
                        <div class="flex items-start gap-2 text-sm">
                            <svg class="w-4 h-4 text-gray-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            </svg>
                            <span class="text-gray-700 flex-1">Jr. Gamarra 345, La Victoria</span>
                            <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=Jr.+Gamarra+345+La+Victoria+Lima', '_blank')" class="px-3 py-1 bg-orange-600 text-white rounded text-xs hover:bg-orange-700">
                                Navegar
                            </button>
                        </div>
                    </div>

                    <div class="mt-3 flex gap-2">
                        <button onclick="markAsDelivered(this, 'Mar√≠a Garc√≠a', 'Gamarra')" class="flex-1 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Marcar Entregado
                        </button>
                        <button onclick="showScreen('detail-screen')" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200">
                            Detalles
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State (hidden when there are deliveries) -->
        <div id="empty-delivery-state" class="hidden bg-white rounded-lg shadow p-12 text-center">
            <svg class="w-20 h-20 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <h3 class="text-xl font-bold text-gray-800 mb-2">No hay entregas programadas</h3>
            <p class="text-gray-600 mb-6">Agrega clientes a tu lista de reparto para empezar</p>
            <button onclick="openAddToDelivery()" class="px-6 py-3 bg-orange-600 text-white rounded-lg font-semibold hover:bg-orange-700">
                Agregar Primera Entrega
            </button>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button onclick="showScreen('map-screen')" class="fixed bottom-20 right-6 w-14 h-14 bg-orange-600 text-white rounded-full shadow-lg hover:bg-orange-700 flex items-center justify-center">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
        </svg>
    </button>
</div>

<!-- MODAL: DETALLES DE ENTREGA -->
<div id="delivery-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="sticky top-0 bg-green-600 text-white p-4 rounded-t-xl">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold">Registrar Entrega</h2>
                <button onclick="closeDeliveryModal()" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <p class="text-green-100 text-sm mt-1" id="modal-client-name">Cliente: Juan Rodr√≠guez</p>
        </div>

        <!-- Form -->
        <div class="p-6 space-y-4">
            <!-- N√∫mero de Gu√≠a -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    N√∫mero de Gu√≠a *
                </label>
                <input 
                    type="text" 
                    id="guia-number"
                    placeholder="Ej: GU-2024-00123" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                >
            </div>

            <!-- Importe Total -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Importe Total (S/.) *
                </label>
                <input 
                    type="number" 
                    id="total-amount"
                    placeholder="0.00" 
                    step="0.01"
                    min="0"
                    oninput="calculateBalance()"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                >
            </div>

            <!-- Tipo de Venta -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Tipo de Venta *
                </label>
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" onclick="selectSaleType('contado')" id="btn-contado" class="sale-type-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors">
                        <div class="text-center">
                            <svg class="w-6 h-6 mx-auto mb-1 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-sm font-medium">Contado</span>
                        </div>
                    </button>
                    <button type="button" onclick="selectSaleType('credito')" id="btn-credito" class="sale-type-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors">
                        <div class="text-center">
                            <svg class="w-6 h-6 mx-auto mb-1 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            <span class="text-sm font-medium">Cr√©dito</span>
                        </div>
                    </button>
                </div>
                <input type="hidden" id="sale-type" value="">
            </div>

            <!-- M√©todo de Pago -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    M√©todo de Pago *
                </label>
                <div class="grid grid-cols-3 gap-3">
                    <button type="button" onclick="selectPaymentMethod('efectivo')" id="btn-efectivo" class="payment-method-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors">
                        <div class="text-center">
                            <span class="text-2xl mb-1">üíµ</span>
                            <p class="text-xs font-medium">Efectivo</p>
                        </div>
                    </button>
                    <button type="button" onclick="selectPaymentMethod('yape')" id="btn-yape" class="payment-method-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors">
                        <div class="text-center">
                            <span class="text-2xl mb-1">üì±</span>
                            <p class="text-xs font-medium">Yape</p>
                        </div>
                    </button>
                    <button type="button" onclick="selectPaymentMethod('plin')" id="btn-plin" class="payment-method-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors">
                        <div class="text-center">
                            <span class="text-2xl mb-1">üí≥</span>
                            <p class="text-xs font-medium">Plin</p>
                        </div>
                    </button>
                </div>
                <input type="hidden" id="payment-method" value="">
            </div>

            <!-- Monto Pagado -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Monto Pagado (S/.) *
                </label>
                <input 
                    type="number" 
                    id="paid-amount"
                    placeholder="0.00" 
                    step="0.01"
                    min="0"
                    oninput="calculateBalance()"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                >
            </div>

            <!-- Saldo Pendiente (calculado autom√°ticamente) -->
            <div id="balance-section" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Saldo Pendiente
                </label>
                <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">Pendiente de cobro:</span>
                        <span id="balance-amount" class="text-2xl font-bold text-amber-600">S/. 0.00</span>
                    </div>
                </div>
            </div>

            <!-- Estado de Pago -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">Estado de Pago:</span>
                    <span id="payment-status" class="px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-full">
                        Sin definir
                    </span>
                </div>
            </div>

            <!-- Observaciones -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Observaciones (opcional)
                </label>
                <textarea 
                    id="observations"
                    rows="3" 
                    placeholder="Notas adicionales sobre la entrega..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                ></textarea>
            </div>

            <!-- Foto de Evidencia -->
            <div class="pt-4 border-t">
                <label class="block text-sm font-medium text-gray-700 mb-3">üì∏ Foto de Evidencia (Opcional)</label>
                
                <!-- Botones para capturar/subir foto -->
                <div class="flex gap-3 mb-3">
                    <button type="button" onclick="capturePhoto()" class="flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Tomar Foto
                    </button>
                    <button type="button" onclick="document.getElementById('photo-upload').click()" class="flex-1 px-4 py-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Subir Imagen
                    </button>
                </div>
                
                <!-- Input oculto para subir foto -->
                <input type="file" id="photo-upload" accept="image/*,.heic,.heif" class="hidden" onchange="handlePhotoUpload(event)">
                
                <!-- Preview de la foto -->
                <div id="photo-preview" class="hidden mt-3">
                    <div class="relative">
                        <img id="photo-image" src="" alt="Evidencia" class="w-full h-48 object-cover rounded-lg border-2 border-gray-300">
                        <button type="button" onclick="removePhoto()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 hover:bg-red-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">‚úÖ Foto capturada. Se enviar√° con la notificaci√≥n de WhatsApp.</p>
                </div>
                
                <!-- Mensaje informativo -->
                <div class="mt-2 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-xs text-blue-800">
                            <p class="font-semibold mb-1">üì∏ Foto de evidencia:</p>
                            <p>La foto se adjuntar√° autom√°ticamente al mensaje de WhatsApp.</p>
                            <p class="mt-1 text-blue-600">
                                ‚úÖ Formatos: JPG, PNG, GIF, WEBP, BMP, HEIC, TIFF, SVG
                            </p>
                            <p class="text-blue-600">
                                üìè Tama√±o m√°ximo: 20 MB
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hora de Entrega (autom√°tica) -->
            <div class="text-xs text-gray-500 text-center">
                Hora de registro: <span id="delivery-time"></span>
            </div>
        </div>

        <!-- Footer -->
        <div class="sticky bottom-0 bg-gray-50 p-4 border-t flex gap-3 rounded-b-xl">
            <button onclick="closeDeliveryModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-white">
                Cancelar
            </button>
            <button onclick="saveDeliveryDetails()" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">
                Guardar Entrega
            </button>
        </div>
    </div>
</div>

<!-- PANTALLA 8: SELECTOR DE UBICACI√ìN EN MAPA -->
<div id="map-picker-screen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b">
            <h2 class="text-xl font-bold text-gray-800">Selecciona la ubicaci√≥n</h2>
            <button onclick="closeMapPicker()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Search -->
        <div class="p-4 border-b">
            <div class="flex gap-2">
                <input type="text" placeholder="Buscar direcci√≥n..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Map -->
        <div class="flex-1 relative">
            <div class="map-mock h-full relative">
                <!-- Crosshair/Pin central -->
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="text-6xl animate-bounce">üìç</div>
                </div>
                
                <!-- Instrucci√≥n -->
                <div class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-lg px-4 py-2">
                    <p class="text-sm text-gray-700">Mueve el mapa para posicionar el pin</p>
                </div>
                
                <!-- Coordenadas actuales -->
                <div class="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg px-3 py-2">
                    <p class="text-xs text-gray-600">Lat: <span class="font-mono">-12.0464</span></p>
                    <p class="text-xs text-gray-600">Lng: <span class="font-mono">-77.0428</span></p>
                </div>
                
                <!-- Bot√≥n ubicaci√≥n actual -->
                <button onclick="alert('Obteniendo ubicaci√≥n GPS...')" class="absolute top-4 right-4 w-10 h-10 bg-white rounded-lg shadow-lg flex items-center justify-center hover:bg-gray-50">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Footer con acciones -->
        <div class="p-4 border-t bg-gray-50">
            <div class="flex gap-3">
                <button onclick="closeMapPicker()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-white">
                    Cancelar
                </button>
                <button onclick="confirmLocation()" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
                    Confirmar Ubicaci√≥n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: AGREGAR CLIENTES AL REPARTO -->
<div id="add-to-delivery-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="bg-orange-600 text-white p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold">Agregar Clientes al Reparto</h2>
                    <p class="text-orange-100 text-sm mt-1">Selecciona los clientes para programar entregas</p>
                </div>
                <button onclick="closeAddToDeliveryModal()" class="text-white hover:bg-orange-700 p-2 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Search -->
        <div class="p-4 border-b">
            <div class="relative">
                <input 
                    type="text" 
                    id="search-clients-delivery" 
                    placeholder="üîç Buscar cliente por nombre, DNI o zona..." 
                    onkeyup="filterClientsForDelivery()"
                    class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                >
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
        </div>

        <!-- Clients List -->
        <div class="flex-1 overflow-y-auto p-4">
            <div id="clients-list-delivery" class="space-y-2">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 p-4 border-t">
            <div class="flex items-center justify-between mb-3">
                <p class="text-sm text-gray-600">
                    <span id="selected-count">0</span> cliente(s) seleccionado(s)
                </p>
                <button onclick="selectAllClients()" class="text-sm text-orange-600 hover:text-orange-700 font-medium">
                    Seleccionar todos
                </button>
            </div>
            <div class="flex gap-3">
                <button onclick="closeAddToDeliveryModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-white">
                    Cancelar
                </button>
                <button onclick="addSelectedClientsToDelivery()" class="flex-1 px-6 py-3 bg-orange-600 text-white rounded-lg font-semibold hover:bg-orange-700">
                    Agregar al Reparto
                </button>
            </div>
        </div>
    </div>
</div>


<!-- PANTALLA 10: PANEL DE CONTROL DE ACCESOS (Solo Jefe) -->
<div id="access-control-screen" class="screen min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-purple-600 text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <button onclick="showScreen('dashboard-screen')" class="text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="text-center flex-1">
                <h1 class="text-2xl font-bold">Control de Accesos</h1>
                <p class="text-purple-100 text-sm">Gesti√≥n de usuarios y permisos</p>
            </div>
            <button onclick="openAddUserModal()" class="text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="max-w-7xl mx-auto p-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-xs">Total Usuarios</p>
                        <p class="text-2xl font-bold text-gray-800 mt-1">8</p>
                    </div>
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-xs">Activos</p>
                        <p class="text-2xl font-bold text-green-600 mt-1">6</p>
                    </div>
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-xs">Conectados</p>
                        <p class="text-2xl font-bold text-blue-600 mt-1">3</p>
                    </div>
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M13 12a1 1 0 11-2 0 1 1 0 012 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-xs">Bloqueados</p>
                        <p class="text-2xl font-bold text-red-600 mt-1">2</p>
                    </div>
                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-3 mb-4">
            <div class="flex gap-2 overflow-x-auto">
                <button onclick="filterUsers('all')" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium whitespace-nowrap">
                    Todos (8)
                </button>
                <button onclick="filterUsers('jefe')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 whitespace-nowrap">
                    üëî Jefe (1)
                </button>
                <button onclick="filterUsers('repartidor')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 whitespace-nowrap">
                    üöö Repartidores (3)
                </button>
                <button onclick="filterUsers('vendedor')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 whitespace-nowrap">
                    üíº Vendedores (2)
                </button>
                <button onclick="filterUsers('contabilidad')" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 whitespace-nowrap">
                    üìä Contabilidad (2)
                </button>
                <button onclick="filterUsers('pending')" class="px-4 py-2 bg-amber-100 text-amber-700 rounded-lg text-sm font-medium hover:bg-amber-200 whitespace-nowrap">
                    ‚è≥ Pendientes (0)
                </button>
            </div>
        </div>

        <!-- Pending Users to Link -->
        <div id="pending-users-section" class="bg-amber-50 border-2 border-amber-200 rounded-lg p-6 mb-6">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
                Usuarios Pendientes de Vinculaci√≥n
                <span class="px-2 py-1 bg-amber-200 text-amber-800 text-xs font-bold rounded-full">0</span>
            </h3>
            <p class="text-sm text-gray-600 mb-4">
                Usuarios registrados que a√∫n no est√°n vinculados a ninguna empresa. Puedes agregarlos a tu equipo.
            </p>
            
            <!-- Search Users -->
            <div class="mb-4">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="search-pending-users" 
                        placeholder="Buscar por email, nombre o DNI..."
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                    >
                    <button onclick="searchPendingUsers()" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-semibold hover:bg-amber-700">
                        Buscar
                    </button>
                </div>
            </div>

            <!-- Pending Users List -->
            <div id="pending-users-list" class="space-y-3">
                <!-- Se llena din√°micamente -->
                <div class="text-center py-8 text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <p class="font-medium">No hay usuarios pendientes</p>
                    <p class="text-sm">Busca usuarios por email para agregarlos a tu empresa</p>
                </div>
            </div>
        </div>

        <!-- Users List -->
        <div class="space-y-3">
            <!-- User 1 - Jefe -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 flex-1">
                        <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-lg">JG</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-gray-800">Jorge Garc√≠a</h3>
                                <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded-full">üëî Jefe</span>
                                <span class="w-2 h-2 bg-green-500 rounded-full" title="Conectado"></span>
                            </div>
                            <p class="text-sm text-gray-600">jgarcia@empresa.com</p>
                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                <span>√öltimo acceso: Ahora</span>
                                <span>‚Ä¢</span>
                                <span>Dispositivo: Chrome - Windows</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openPermissionsModal('Jorge Garc√≠a', 'jefe')" class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm hover:bg-purple-200">
                            Gestionar Permisos
                        </button>
                        <button onclick="forceLogout('Jorge Garc√≠a')" class="px-3 py-2 bg-red-100 text-red-700 rounded-lg text-sm hover:bg-red-200">
                            Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            </div>

            <!-- User 2 - Repartidor Conectado -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 flex-1">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-lg">CP</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-gray-800">Carlos P√©rez</h3>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">üöö Repartidor</span>
                                <span class="w-2 h-2 bg-green-500 rounded-full" title="Conectado"></span>
                            </div>
                            <p class="text-sm text-gray-600">cperez@empresa.com</p>
                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                <span>√öltimo acceso: Hace 5 min</span>
                                <span>‚Ä¢</span>
                                <span>Dispositivo: Mobile - Android</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openPermissionsModal('Carlos P√©rez', 'repartidor')" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200">
                            Gestionar Permisos
                        </button>
                        <button onclick="forceLogout('Carlos P√©rez')" class="px-3 py-2 bg-red-100 text-red-700 rounded-lg text-sm hover:bg-red-200">
                            Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            </div>

            <!-- User 3 - Vendedor Conectado -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 flex-1">
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-lg">MR</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-gray-800">Mar√≠a Rodr√≠guez</h3>
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">üíº Vendedor</span>
                                <span class="w-2 h-2 bg-green-500 rounded-full" title="Conectado"></span>
                            </div>
                            <p class="text-sm text-gray-600">mrodriguez@empresa.com</p>
                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                <span>√öltimo acceso: Hace 2 min</span>
                                <span>‚Ä¢</span>
                                <span>Dispositivo: Chrome - Mac</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openPermissionsModal('Mar√≠a Rodr√≠guez', 'vendedor')" class="px-3 py-2 bg-green-100 text-green-700 rounded-lg text-sm hover:bg-green-200">
                            Gestionar Permisos
                        </button>
                        <button onclick="forceLogout('Mar√≠a Rodr√≠guez')" class="px-3 py-2 bg-red-100 text-red-700 rounded-lg text-sm hover:bg-red-200">
                            Cerrar Sesi√≥n
                        </button>
                    </div>
                </div>
            </div>

            <!-- User 4 - Contabilidad Activo (no conectado) -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 flex-1">
                        <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-lg">LC</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-gray-800">Luis Castro</h3>
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs font-medium rounded-full">üìä Contabilidad</span>
                                <span class="w-2 h-2 bg-gray-400 rounded-full" title="Desconectado"></span>
                            </div>
                            <p class="text-sm text-gray-600">lcastro@empresa.com</p>
                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                <span>√öltimo acceso: Hace 2 horas</span>
                                <span>‚Ä¢</span>
                                <span>Dispositivo: Chrome - Windows</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openPermissionsModal('Luis Castro', 'contabilidad')" class="px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm hover:bg-orange-200">
                            Gestionar Permisos
                        </button>
                        <button class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200">
                            Bloquear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: GESTIONAR PERMISOS DE USUARIO -->
<div id="permissions-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="sticky top-0 bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6 rounded-t-xl">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold" id="permissions-user-name">Carlos P√©rez</h2>
                    <p class="text-purple-100 text-sm mt-1">
                        <span id="permissions-user-role">üöö Repartidor</span> ‚Ä¢ 
                        <span id="permissions-user-email">cperez@empresa.com</span>
                    </p>
                </div>
                <button onclick="closePermissionsModal()" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="p-6 space-y-6">
            <!-- General Access -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    Acceso General
                </h3>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Acceso a la aplicaci√≥n</p>
                            <p class="text-sm text-gray-600">Permite al usuario iniciar sesi√≥n</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-purple-600 rounded">
                    </label>
                </div>
            </div>

            <!-- Clients Module -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    Gesti√≥n de Clientes
                </h3>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Ver clientes</p>
                            <p class="text-sm text-gray-600">Ver lista y detalles de clientes</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-blue-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Agregar clientes</p>
                            <p class="text-sm text-gray-600">Crear nuevos registros de clientes</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-blue-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Editar clientes</p>
                            <p class="text-sm text-gray-600">Modificar informaci√≥n de clientes existentes</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-blue-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Eliminar clientes</p>
                            <p class="text-sm text-gray-600">Borrar clientes del sistema</p>
                        </div>
                        <input type="checkbox" class="w-5 h-5 text-blue-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Ver ubicaciones en mapa</p>
                            <p class="text-sm text-gray-600">Acceso al mapa de clientes</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-blue-600 rounded">
                    </label>
                </div>
            </div>

            <!-- Deliveries Module -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    Repartos y Entregas
                </h3>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Ver repartos programados</p>
                            <p class="text-sm text-gray-600">Acceso a la lista de reparto del d√≠a</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-orange-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Programar repartos</p>
                            <p class="text-sm text-gray-600">Agregar clientes a la lista de reparto</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-orange-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Marcar entregas como completadas</p>
                            <p class="text-sm text-gray-600">Registrar entregas realizadas</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-orange-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Modificar prioridades</p>
                            <p class="text-sm text-gray-600">Cambiar orden de entregas prioritarias</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-orange-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Ver historial de entregas</p>
                            <p class="text-sm text-gray-600">Acceso al historial completo</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-orange-600 rounded">
                    </label>
                </div>
            </div>

            <!-- Reports and Finance -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    Reportes y Finanzas
                </h3>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Ver datos financieros</p>
                            <p class="text-sm text-gray-600">Acceso a importes y cobros</p>
                        </div>
                        <input type="checkbox" class="w-5 h-5 text-green-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Ver saldos pendientes</p>
                            <p class="text-sm text-gray-600">Ver cr√©ditos y deudas de clientes</p>
                        </div>
                        <input type="checkbox" class="w-5 h-5 text-green-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Exportar reportes a Excel</p>
                            <p class="text-sm text-gray-600">Descargar datos en formato Excel/CSV</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-green-600 rounded">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Ver reportes del d√≠a</p>
                            <p class="text-sm text-gray-600">Resumen de entregas diarias</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-green-600 rounded">
                    </label>
                </div>
            </div>

            <!-- Notifications -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    Notificaciones
                </h3>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div>
                            <p class="font-medium text-gray-800">Recibir notificaciones</p>
                            <p class="text-sm text-gray-600">Alertas de nuevas entregas y actualizaciones</p>
                        </div>
                        <input type="checkbox" checked class="w-5 h-5 text-yellow-600 rounded">
                    </label>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="sticky bottom-0 bg-gray-50 p-6 border-t flex gap-3 rounded-b-xl">
            <button onclick="closePermissionsModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-white">
                Cancelar
            </button>
            <button onclick="savePermissions()" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700">
                Guardar Cambios
            </button>
        </div>
    </div>
</div>

<!-- PANTALLA: CUENTAS POR COBRAR -->
<div id="accounts-receivable-screen" class="screen min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b sticky top-0 z-10">
        <div class="max-w-7xl mx-auto p-4">
            <div class="flex items-center justify-between">
                <button onclick="showScreen('dashboard-screen')" class="text-blue-600 hover:text-blue-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h1 class="text-xl font-bold text-gray-800">üí∞ Cuentas por Cobrar</h1>
                <button onclick="exportAccountsReceivableToExcel()" class="text-green-600 hover:text-green-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="max-w-7xl mx-auto p-4">
        <!-- Total Summary -->
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs text-red-700 font-medium">Total por Cobrar</p>
                        <p id="total-debt" class="text-2xl font-bold text-red-600">S/. 0.00</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs text-orange-700 font-medium">Clientes Deudores</p>
                        <p id="total-debtors" class="text-2xl font-bold text-orange-600">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Button -->
        <button onclick="exportAccountsReceivableToExcel()" class="w-full mb-4 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2 font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            üìä Exportar Cuentas por Cobrar a Excel
        </button>

        <!-- Debtors List -->
        <div id="debtors-list" class="space-y-3">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- MODAL: SESSION EXPIRED -->
<div id="session-expired-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md text-center">
        <div class="w-20 h-20 bg-red-100 rounded-full mx-auto mb-4 flex items-center justify-center">
            <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Sesi√≥n Cerrada</h2>
        <p class="text-gray-600 mb-6">
            Tu sesi√≥n ha sido cerrada porque se detect√≥ un inicio de sesi√≥n en otro dispositivo.
            <br><br>
            <strong>Pol√≠tica de sesi√≥n √∫nica:</strong> Solo puedes estar conectado en un dispositivo a la vez.
        </p>
        <button onclick="location.reload()" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">
            Volver al Login
        </button>
    </div>
</div>

<script>
// Sistema de roles y permisos
const ROLES = {
    jefe: {
        name: 'üëî Jefe',
        permissions: ['all'], // Acceso total
        dashboardAccess: true,
        accessControl: true
    },
    repartidor: {
        name: 'üöö Repartidor',
        permissions: ['clients', 'deliveries', 'map', 'mark_delivery'],
        dashboardAccess: true,
        accessControl: false
    },
    vendedor: {
        name: 'üíº Vendedor',
        permissions: ['clients', 'view_reports', 'export'],
        dashboardAccess: true,
        accessControl: false
    },
    contabilidad: {
        name: 'üìä Contabilidad',
        permissions: ['clients_readonly', 'deliveries_readonly', 'reports', 'export'],
        dashboardAccess: true,
        accessControl: false
    }
};

// ==========================================
// SISTEMA MULTI-TENANT (MULTI-EMPRESA)
// ==========================================

// Variable global para la empresa actual
let currentCompany = null;

// Funci√≥n para generar ID √∫nico de empresa
function generateCompanyId() {
    return 'company_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Funci√≥n para crear empresa (cuando el Jefe se registra)
function createCompany(companyData) {
    const companyId = generateCompanyId();
    
    const company = {
        id: companyId,
        name: companyData.name,
        ruc: companyData.ruc,
        createdAt: new Date().toISOString(),
        status: 'active',
        plan: 'basico', // basico, premium, pro
        settings: {
            maxClients: 10, // Seg√∫n plan
            maxUsers: 5,
            features: ['clients', 'deliveries', 'reports']
        },
        owner: companyData.ownerEmail
    };
    
    // Guardar empresa en localStorage
    let companies = JSON.parse(localStorage.getItem('companies') || '[]');
    companies.push(company);
    localStorage.setItem('companies', JSON.stringify(companies));
    
    console.log(`‚úÖ Empresa creada: ${company.name} (ID: ${companyId})`);
    return companyId;
}

// Funci√≥n para obtener empresa por RUC
function getCompanyByRUC(ruc) {
    const companies = JSON.parse(localStorage.getItem('companies') || '[]');
    return companies.find(c => c.ruc === ruc);
}

// Funci√≥n para obtener empresa por ID
function getCompanyById(companyId) {
    const companies = JSON.parse(localStorage.getItem('companies') || '[]');
    return companies.find(c => c.id === companyId);
}

// Funci√≥n para guardar datos con prefijo de empresa
function saveCompanyData(dataType, data) {
    if (!currentCompany) {
        console.error('‚ùå No hay empresa activa');
        return false;
    }
    
    const key = `${currentCompany.id}_${dataType}`;
    localStorage.setItem(key, JSON.stringify(data));
    console.log(`üíæ Guardado en: ${currentCompany.name} - ${dataType}`);
    return true;
}

// Funci√≥n para obtener datos de la empresa actual
function getCompanyData(dataType) {
    if (!currentCompany) {
        console.error('‚ùå No hay empresa activa');
        return null;
    }
    
    const key = `${currentCompany.id}_${dataType}`;
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : null;
}

// Funci√≥n para agregar cliente (con empresa)
function addClientToCompany(clientData) {
    if (!currentCompany) {
        alert('‚ùå Error: No hay empresa activa');
        return false;
    }
    
    // Obtener clientes de la empresa
    let clients = getCompanyData('clients') || [];
    
    // Verificar l√≠mite del plan
    if (clients.length >= currentCompany.settings.maxClients) {
        alert(`‚ö†Ô∏è L√≠mite alcanzado\n\nTu plan ${currentCompany.plan} permite m√°ximo ${currentCompany.settings.maxClients} clientes.\n\nActualiza tu plan para agregar m√°s clientes.`);
        return false;
    }
    
    // Agregar cliente con ID √∫nico
    const client = {
        ...clientData,
        id: 'client_' + Date.now(),
        companyId: currentCompany.id,
        createdAt: new Date().toISOString()
    };
    
    clients.push(client);
    saveCompanyData('clients', clients);
    
    console.log(`‚úÖ Cliente agregado a ${currentCompany.name}`);
    return true;
}

// Funci√≥n para obtener clientes de la empresa actual
function getCompanyClients() {
    return getCompanyData('clients') || [];
}

// Funci√≥n para agregar entrega (con empresa)
function addDeliveryToCompany(deliveryData) {
    if (!currentCompany) {
        alert('‚ùå Error: No hay empresa activa');
        return false;
    }
    
    let deliveries = getCompanyData('deliveries') || [];
    
    const delivery = {
        ...deliveryData,
        id: 'delivery_' + Date.now(),
        companyId: currentCompany.id,
        createdAt: new Date().toISOString()
    };
    
    deliveries.push(delivery);
    saveCompanyData('deliveries', deliveries);
    
    console.log(`‚úÖ Entrega agregada a ${currentCompany.name}`);
    return true;
}

// Funci√≥n para obtener entregas de la empresa actual
function getCompanyDeliveries() {
    return getCompanyData('deliveries') || [];
}

// Funci√≥n para agregar usuario a empresa
function addUserToCompany(userData, companyId) {
    const company = getCompanyById(companyId);
    
    if (!company) {
        alert('‚ùå Error: Empresa no encontrada');
        return false;
    }
    
    // Obtener usuarios de la empresa
    const key = `${companyId}_users`;
    let users = JSON.parse(localStorage.getItem(key) || '[]');
    
    // Verificar l√≠mite del plan
    if (users.length >= company.settings.maxUsers) {
        alert(`‚ö†Ô∏è L√≠mite alcanzado\n\nTu plan ${company.plan} permite m√°ximo ${company.settings.maxUsers} usuarios.\n\nActualiza tu plan para agregar m√°s usuarios.`);
        return false;
    }
    
    // Agregar usuario
    const user = {
        ...userData,
        companyId: companyId,
        companyName: company.name,
        addedAt: new Date().toISOString()
    };
    
    users.push(user);
    localStorage.setItem(key, JSON.stringify(users));
    
    console.log(`‚úÖ Usuario agregado a ${company.name}`);
    return true;
}

// Funci√≥n para obtener usuarios de una empresa
function getCompanyUsers(companyId) {
    const key = `${companyId}_users`;
    return JSON.parse(localStorage.getItem(key) || '[]');
}

// Variable global para el rol seleccionado en registro
let selectedRegisterRole = null;

// Funci√≥n para abrir formulario de registro seg√∫n el rol
function openRegisterForm(role) {
    selectedRegisterRole = role;
    const roleNames = {
        jefe: 'üëî Jefe / Administrador',
        repartidor: 'üöö Repartidor',
        vendedor: 'üíº Vendedor',
        contabilidad: 'üìä Contabilidad y Log√≠stica'
    };
    
    document.getElementById('register-role-name').textContent = roleNames[role];
    
    // Mostrar secci√≥n seg√∫n el rol
    const companySection = document.getElementById('company-section');
    const joinCompanySection = document.getElementById('join-company-section');
    
    if (role === 'jefe') {
        // Jefe crea empresa
        companySection.classList.remove('hidden');
        joinCompanySection.classList.add('hidden');
        document.getElementById('company-name').required = true;
        document.getElementById('company-ruc').required = true;
    } else {
        // Otros roles se unen a empresa
        companySection.classList.add('hidden');
        joinCompanySection.classList.remove('hidden');
        document.getElementById('company-name').required = false;
        document.getElementById('company-ruc').required = false;
    }
    
    showScreen('register-form-screen');
}

// Funci√≥n para alternar m√©todo de uni√≥n a empresa
function toggleJoinMethod(method) {
    const rucSection = document.getElementById('ruc-input-section');
    const inviteSection = document.getElementById('invite-info-section');
    
    if (method === 'ruc') {
        rucSection.classList.remove('hidden');
        inviteSection.classList.add('hidden');
    } else {
        rucSection.classList.add('hidden');
        inviteSection.classList.remove('hidden');
    }
}

// Funci√≥n para manejar el registro
function handleRegister(event) {
    event.preventDefault();
    
    const fullname = document.getElementById('register-fullname').value;
    const dni = document.getElementById('register-dni').value;
    const phone = document.getElementById('register-phone').value;
    const whatsapp = document.getElementById('register-whatsapp').value.trim();
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const passwordConfirm = document.getElementById('register-password-confirm').value;
    
    // Validar que las contrase√±as coincidan
    if (password !== passwordConfirm) {
        alert('‚ùå Las contrase√±as no coinciden. Por favor verifica.');
        return;
    }
    
    // Validar DNI (8 d√≠gitos)
    if (dni.length !== 8 || !/^\d+$/.test(dni)) {
        alert('‚ùå El DNI debe tener exactamente 8 d√≠gitos.');
        return;
    }
    
    // Validar WhatsApp
    const cleanWhatsApp = whatsapp.replace(/[^0-9]/g, '');
    if (cleanWhatsApp.length < 10) {
        alert('‚ùå El n√∫mero de WhatsApp debe tener al menos 10 d√≠gitos.\n\nEjemplo: 51923190308 (Per√∫)');
        return;
    }
    
    // Datos adicionales para Jefe
    let companyName = '';
    let companyRuc = '';
    let companyId = null;
    
    if (selectedRegisterRole === 'jefe') {
        companyName = document.getElementById('company-name').value;
        companyRuc = document.getElementById('company-ruc').value;
        
        // Validar RUC (11 d√≠gitos)
        if (companyRuc.length !== 11 || !/^\d+$/.test(companyRuc)) {
            alert('‚ùå El RUC debe tener exactamente 11 d√≠gitos.');
            return;
        }
        
        // Verificar si el RUC ya existe
        const existingCompany = getCompanyByRUC(companyRuc);
        if (existingCompany) {
            alert('‚ùå Este RUC ya est√° registrado.\n\nLa empresa ya existe en el sistema. Si eres parte de esta empresa, solicita acceso al administrador.');
            return;
        }
        
        // Crear empresa
        companyId = createCompany({
            name: companyName,
            ruc: companyRuc,
            ownerEmail: email
        });
        
        console.log(`üè¢ Empresa creada con ID: ${companyId}`);
    }
    
    // Crear cuenta en localStorage (simulaci√≥n)
    const newUser = {
        fullname: fullname,
        dni: dni,
        phone: phone,
        whatsapp: cleanWhatsApp, // N√∫mero de WhatsApp limpio
        email: email,
        password: password, // En producci√≥n, esto se hashear√≠a
        role: selectedRegisterRole,
        companyId: companyId, // null para usuarios sin empresa (Repartidor, Vendedor, Contabilidad)
        companyName: companyName,
        companyRuc: companyRuc,
        status: selectedRegisterRole === 'jefe' ? 'active' : 'pending', // pending = esperando vinculaci√≥n
        createdAt: new Date().toISOString()
    };
    
    // ============================================
    // AUTO-CONFIGURAR WHATSAPP SI ES JEFE
    // ============================================
    if (selectedRegisterRole === 'jefe') {
        WHATSAPP_CONFIG.groupNumber = cleanWhatsApp;
        localStorage.setItem('whatsapp_group_number', cleanWhatsApp);
        console.log('üì± WhatsApp auto-configurado:', cleanWhatsApp);
    }
    
    // Guardar usuario global
    let users = JSON.parse(localStorage.getItem('users') || '[]');
    
    // Verificar si el email ya existe
    if (users.some(u => u.email === email)) {
        alert('‚ùå Este email ya est√° registrado. Por favor usa otro email o inicia sesi√≥n.');
        return;
    }
    
    users.push(newUser);
    localStorage.setItem('users', JSON.stringify(users));
    
    // Si es Jefe, agregarlo como primer usuario de su empresa
    if (selectedRegisterRole === 'jefe' && companyId) {
        addUserToCompany(newUser, companyId);
    }
    
    // Mensaje de √©xito
    const roleNames = {
        jefe: 'Jefe / Administrador',
        repartidor: 'Repartidor',
        vendedor: 'Vendedor',
        contabilidad: 'Contabilidad y Log√≠stica'
    };
    
    let successMessage = `‚úÖ ¬°Cuenta creada exitosamente!\n\nüë§ Usuario: ${fullname}\nüìß Email: ${email}\nüéØ Rol: ${roleNames[selectedRegisterRole]}\nüì± WhatsApp: +${cleanWhatsApp}`;
    
    if (selectedRegisterRole === 'jefe') {
        // Mensaje para Jefe
        successMessage += `\n\nüè¢ Empresa: ${companyName}\nüìã RUC: ${companyRuc}\nüÜî ID Empresa: ${companyId}`;
        successMessage += `\n\nüí° Como Jefe, ahora puedes:\n‚Ä¢ Agregar usuarios a tu empresa\n‚Ä¢ Gestionar clientes y repartos\n‚Ä¢ Controlar accesos y permisos`;
    } else {
        // Mensaje para otros roles (sin empresa)
        successMessage += `\n\n‚è≥ Estado: Pendiente de vinculaci√≥n`;
        successMessage += `\n\nüìå Pr√≥ximos pasos:\n`;
        successMessage += `1. Inicia sesi√≥n con tus credenciales\n`;
        successMessage += `2. Podr√°s usar la aplicaci√≥n en modo DEMO\n`;
        successMessage += `3. Solicita al Jefe/Admin que te agregue a su empresa\n`;
        successMessage += `4. Una vez vinculado, tendr√°s acceso a los datos reales\n`;
        successMessage += `\nüíº Para vincularte a una empresa:\n`;
        successMessage += `El Jefe debe buscarte por email (${email}) en el Panel de Control de Accesos y agregarte a su empresa.`;
    }
    
    successMessage += '\n\n‚úÖ Ya puedes iniciar sesi√≥n con tus credenciales.';
    
    alert(successMessage);
    
    // Limpiar formulario
    document.getElementById('register-fullname').value = '';
    document.getElementById('register-dni').value = '';
    document.getElementById('register-phone').value = '';
    document.getElementById('register-email').value = '';
    document.getElementById('register-password').value = '';
    document.getElementById('register-password-confirm').value = '';
    if (selectedRegisterRole === 'jefe') {
        document.getElementById('company-name').value = '';
        document.getElementById('company-ruc').value = '';
    }
    
    // Redirigir a login
    showScreen('login-screen');
    
    // Pre-llenar el email en login
    document.getElementById('login-email').value = email;
    document.getElementById('user-role').value = selectedRegisterRole;
}

// Funci√≥n para crear solicitud de acceso
function createAccessRequest(companyId, requestData) {
    const key = `${companyId}_access_requests`;
    let requests = JSON.parse(localStorage.getItem(key) || '[]');
    requests.push(requestData);
    localStorage.setItem(key, JSON.stringify(requests));
}

// Funci√≥n para obtener solicitudes de acceso pendientes
function getAccessRequests(companyId) {
    const key = `${companyId}_access_requests`;
    return JSON.parse(localStorage.getItem(key) || '[]');
}

// Variable global para sesi√≥n actual
let currentSession = null;

// Funci√≥n para generar ID de sesi√≥n √∫nico
function generateSessionId() {
    return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// ============================================
// LOGIN R√ÅPIDO PARA DEMO
// ============================================
function quickLogin(role) {
    console.log('üöÄ Login r√°pido como:', role);
    
    const credentials = {
        jefe: { email: 'jefe@empresa.com', password: '123456' },
        repartidor: { email: 'repartidor@empresa.com', password: '123456' },
        vendedor: { email: 'vendedor@empresa.com', password: '123456' },
        contabilidad: { email: 'contabilidad@empresa.com', password: '123456' }
    };
    
    if (!credentials[role]) {
        alert('‚ùå Rol no v√°lido');
        return;
    }
    
    // Llenar formulario
    document.getElementById('user-role').value = role;
    document.getElementById('login-email').value = credentials[role].email;
    document.getElementById('login-password').value = credentials[role].password;
    
    // Hacer login autom√°ticamente despu√©s de un breve delay
    setTimeout(() => {
        handleLogin();
    }, 300);
}

// Funci√≥n para manejar el login
function handleLogin() {
    const role = document.getElementById('user-role').value;
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    
    console.log('üîê Intentando login:', { role, email, password: '***' });
    
    if (!email || !password) {
        alert('‚ö†Ô∏è Por favor completa todos los campos');
        return;
    }
    
    // Validar contrase√±a m√≠nima
    if (password.length < 6) {
        alert('‚ùå Contrase√±a incorrecta (m√≠nimo 6 caracteres)');
        return;
    }
    
    // Buscar usuario registrado en la base de datos
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    console.log('üë• Usuarios en BD:', users);
    console.log('üîç Buscando:', { email, role, password });
    
    // Buscar paso por paso para debug
    const usersByEmail = users.filter(u => u.email === email);
    console.log('üìß Usuarios con este email:', usersByEmail);
    
    const usersByRole = users.filter(u => u.role === role);
    console.log('üëî Usuarios con este rol:', usersByRole);
    
    const user = users.find(u => u.email === email && u.role === role && u.password === password);
    console.log('üë§ Usuario encontrado:', user);
    
    // Validar contrase√±a
    if (!user) {
        console.error('‚ùå Login fallido');
        console.error('   Email ingresado:', email);
        console.error('   Rol ingresado:', role);
        console.error('   Password ingresado:', password);
        
        // Mostrar usuarios disponibles (solo en debug)
        console.error('   Usuarios disponibles:');
        users.forEach(u => {
            console.error(`      - ${u.email} (${u.role}) pass: ${u.password}`);
        });
        
        alert('‚ùå Email, rol o contrase√±a incorrectos\n\nCredenciales demo:\nEmail: jefe@empresa.com\nPassword: 123456\nRol: Jefe');
        return;
    }
    
    console.log('‚úÖ Credenciales v√°lidas');
    
    
    // Cargar empresa del usuario
    if (user.companyId) {
        const companies = JSON.parse(localStorage.getItem('companies') || '[]');
        currentCompany = companies.find(c => c.id === user.companyId);
        
        if (!currentCompany) {
            console.error('‚ùå Empresa no encontrada:', user.companyId);
            alert('‚ùå Error: No se pudo cargar la empresa');
            return;
        }
        console.log(`üè¢ Empresa cargada: ${currentCompany.name}`);
    } else {
        // Usuario sin empresa asignada
        console.log('‚ö†Ô∏è Usuario sin empresa asignada');
        currentCompany = {
            id: 'pending',
            name: 'Sin Empresa',
            ruc: '',
            plan: 'ninguno',
            status: 'pending'
        };
    }
    
    // Crear sesi√≥n
    const sessionId = 'session_' + Date.now();
    currentSession = {
        sessionId: sessionId,
        email: email,
        role: role,
        roleName: ROLES[role].name,
        companyId: currentCompany.id,
        companyName: currentCompany.name,
        loginTime: new Date().toISOString(),
        lastActivity: new Date().toISOString()
    };
    
    // Guardar sesi√≥n
    localStorage.setItem('currentSession', JSON.stringify(currentSession));
    
    console.log('‚úÖ Sesi√≥n creada:', currentSession);
    
    // Mostrar dashboard
    showScreen('dashboard-screen');
    updateDashboardForRole(role);
    
    // Mensaje de bienvenida
    let welcomeMsg = `‚úÖ Bienvenido, ${ROLES[role].name}!\n\n`;
    
    if (currentCompany.status === 'demo') {
        welcomeMsg += `üéÆ Modo DEMO\n\n`;
        welcomeMsg += `Est√°s usando la aplicaci√≥n en modo demostraci√≥n.\n`;
    } else {
        welcomeMsg += `üè¢ Empresa: ${currentCompany.name}\n`;
        welcomeMsg += `üìã RUC: ${currentCompany.ruc}\n`;
        welcomeMsg += `üìä Plan: ${currentCompany.plan.toUpperCase()}\n\n`;
    }
    
    welcomeMsg += `Sesi√≥n iniciada exitosamente.`;
    
    alert(welcomeMsg);
}
// Funci√≥n para actualizar dashboard seg√∫n el rol
function updateDashboardForRole(role) {
    const roleData = ROLES[role];
    
    // Ocultar/mostrar bot√≥n de control de accesos
    const accessControlBtn = document.getElementById('access-control-btn');
    if (accessControlBtn) {
        accessControlBtn.style.display = roleData.accessControl ? 'block' : 'none';
    }
    
    // Actualizar nombre de usuario en header
    const welcomeText = document.querySelector('#dashboard-screen .text-blue-100');
    if (welcomeText) {
        welcomeText.textContent = `Bienvenido, ${roleData.name}`;
    }
    
    // Deshabilitar funciones seg√∫n permisos
    if (role === 'contabilidad') {
        // Contabilidad: solo lectura en clientes y repartos
        const addClientBtn = document.querySelector('button[onclick*="add-client"]');
        if (addClientBtn) {
            addClientBtn.disabled = true;
            addClientBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }
    
    if (role === 'vendedor') {
        // Vendedor: no puede ver repartos
        const deliveryBtn = document.querySelector('button[onclick*="delivery-screen"]');
        if (deliveryBtn) {
            deliveryBtn.style.display = 'none';
        }
    }
}

// Funci√≥n para monitorear sesi√≥n
function startSessionMonitoring() {
    // Verificar cada 5 segundos si la sesi√≥n sigue activa
    setInterval(() => {
        const session = JSON.parse(localStorage.getItem('currentSession'));
        if (!session) return;
        
        const closedSessions = JSON.parse(localStorage.getItem('closedSessions') || '[]');
        
        if (closedSessions.includes(session.sessionId)) {
            // Esta sesi√≥n fue cerrada desde otro dispositivo
            handleSessionClosed();
        }
    }, 5000);
}

// Funci√≥n para manejar sesi√≥n cerrada
function handleSessionClosed() {
    // Mostrar modal de sesi√≥n expirada
    document.getElementById('session-expired-modal').style.display = 'flex';
    
    // Limpiar sesi√≥n local
    localStorage.removeItem('currentSession');
    
    // Opcional: reproducir sonido de alerta
    // const audio = new Audio('data:audio/wav;base64,...');
    // audio.play();
}

// Funci√≥n para forzar cierre de sesi√≥n (solo Jefe)
function forceLogout(userName) {
    const session = JSON.parse(localStorage.getItem('currentSession'));
    
    if (!session || session.role !== 'jefe') {
        alert('‚ùå No tienes permisos para realizar esta acci√≥n');
        return;
    }
    
    if (confirm(`¬øEst√°s seguro de cerrar la sesi√≥n de ${userName}?\n\nEsta acci√≥n desconectar√° al usuario inmediatamente.`)) {
        // En producci√≥n, esto har√≠a una llamada al servidor
        alert(`‚úÖ Sesi√≥n de ${userName} cerrada exitosamente.\n\nEl usuario ser√° desconectado en su pr√≥xima verificaci√≥n (m√°ximo 5 segundos).`);
        
        // Log de actividad
        logSessionActivity('force_logout', userName, session.role);
    }
}

// Funci√≥n para registrar actividad
function logSessionActivity(action, user, role) {
    const logs = JSON.parse(localStorage.getItem('sessionLogs') || '[]');
    logs.unshift({
        action: action,
        user: user,
        role: role,
        timestamp: new Date().toISOString(),
        deviceInfo: navigator.userAgent.substr(0, 50)
    });
    
    // Mantener solo los √∫ltimos 100 registros
    if (logs.length > 100) {
        logs.splice(100);
    }
    
    localStorage.setItem('sessionLogs', JSON.stringify(logs));
}

// Funci√≥n para buscar usuarios pendientes
function searchPendingUsers() {
    const searchTerm = document.getElementById('search-pending-users').value.toLowerCase().trim();
    
    if (!searchTerm) {
        alert('‚ö†Ô∏è Por favor ingresa un email, nombre o DNI para buscar');
        return;
    }
    
    if (!currentCompany) {
        alert('‚ùå Error: No hay empresa activa');
        return;
    }
    
    // Obtener todos los usuarios registrados
    const allUsers = JSON.parse(localStorage.getItem('users') || '[]');
    
    // Filtrar usuarios sin empresa o con estado pending
    const pendingUsers = allUsers.filter(u => 
        (!u.companyId || u.status === 'pending') && 
        u.role !== 'jefe' && // Excluir jefes
        (
            u.email.toLowerCase().includes(searchTerm) ||
            u.fullname.toLowerCase().includes(searchTerm) ||
            u.dni.includes(searchTerm)
        )
    );
    
    const listContainer = document.getElementById('pending-users-list');
    
    if (pendingUsers.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <p class="font-medium">No se encontraron usuarios</p>
                <p class="text-sm">No hay usuarios registrados con "${searchTerm}"</p>
            </div>
        `;
        return;
    }
    
    // Mostrar usuarios encontrados
    const roleIcons = {
        repartidor: 'üöö',
        vendedor: 'üíº',
        contabilidad: 'üìä'
    };
    
    const roleColors = {
        repartidor: 'blue',
        vendedor: 'green',
        contabilidad: 'orange'
    };
    
    listContainer.innerHTML = pendingUsers.map(user => {
        const color = roleColors[user.role];
        const icon = roleIcons[user.role];
        
        return `
            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-${color}-500">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 flex-1">
                        <div class="w-12 h-12 bg-${color}-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-lg">${user.fullname.split(' ').map(n => n[0]).join('').substr(0,2)}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-gray-800">${user.fullname}</h3>
                                <span class="px-2 py-1 bg-${color}-100 text-${color}-700 text-xs font-medium rounded-full">${icon} ${user.role}</span>
                            </div>
                            <p class="text-sm text-gray-600">${user.email}</p>
                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                <span>DNI: ${user.dni}</span>
                                <span>‚Ä¢</span>
                                <span>Tel: ${user.phone}</span>
                                <span>‚Ä¢</span>
                                <span>Registrado: ${new Date(user.createdAt).toLocaleDateString('es-PE')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="linkUserToCompany('${user.email}')" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Agregar a mi Empresa
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Funci√≥n para vincular usuario a la empresa
function linkUserToCompany(userEmail) {
    if (!currentCompany) {
        alert('‚ùå Error: No hay empresa activa');
        return;
    }
    
    // Obtener usuario
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const userIndex = users.findIndex(u => u.email === userEmail);
    
    if (userIndex === -1) {
        alert('‚ùå Error: Usuario no encontrado');
        return;
    }
    
    const user = users[userIndex];
    
    // Verificar si ya est√° en otra empresa
    if (user.companyId && user.companyId !== currentCompany.id) {
        const otherCompany = getCompanyById(user.companyId);
        const confirmed = confirm(
            `‚ö†Ô∏è Usuario ya vinculado\n\n` +
            `${user.fullname} ya est√° vinculado a:\n` +
            `üè¢ ${otherCompany ? otherCompany.name : 'Otra empresa'}\n\n` +
            `¬øDeseas transferirlo a tu empresa?\n` +
            `(El usuario perder√° acceso a la empresa anterior)`
        );
        
        if (!confirmed) return;
    }
    
    // Confirmar vinculaci√≥n
    const confirmed = confirm(
        `‚ûï Agregar Usuario a tu Empresa\n\n` +
        `üë§ Usuario: ${user.fullname}\n` +
        `üìß Email: ${user.email}\n` +
        `üéØ Rol: ${user.role}\n\n` +
        `üè¢ Empresa: ${currentCompany.name}\n` +
        `üìã RUC: ${currentCompany.ruc}\n\n` +
        `¬øConfirmas agregar este usuario a tu empresa?`
    );
    
    if (!confirmed) return;
    
    // Actualizar usuario
    users[userIndex].companyId = currentCompany.id;
    users[userIndex].companyName = currentCompany.name;
    users[userIndex].companyRuc = currentCompany.ruc;
    users[userIndex].status = 'active';
    users[userIndex].linkedAt = new Date().toISOString();
    users[userIndex].linkedBy = currentSession.email;
    
    localStorage.setItem('users', JSON.stringify(users));
    
    // Agregar a la lista de usuarios de la empresa
    addUserToCompany(users[userIndex], currentCompany.id);
    
    // Mostrar confirmaci√≥n
    alert(
        `‚úÖ Usuario vinculado exitosamente\n\n` +
        `${user.fullname} ahora tiene acceso a:\n` +
        `üè¢ ${currentCompany.name}\n\n` +
        `El usuario podr√° iniciar sesi√≥n y acceder a los datos de la empresa.`
    );
    
    // Recargar b√∫squeda
    searchPendingUsers();
}

// Funci√≥n para filtrar usuarios en el panel
function filterUsers(filter) {
    alert(`üöß Filtro "${filter}" - Funci√≥n en desarrollo\n\nEsta funci√≥n mostrar√° solo usuarios de ese tipo.`);
}

// Funci√≥n para abrir modal de agregar usuario
function openAddUserModal() {
    alert('üöÄ Funci√≥n en desarrollo: Agregar nuevo usuario\n\nPodr√°s crear usuarios con los siguientes roles:\n‚Ä¢ Jefe\n‚Ä¢ Repartidor\n‚Ä¢ Vendedor\n‚Ä¢ Contabilidad y Log√≠stica');
}

// Funci√≥n para abrir modal de permisos
function openPermissionsModal(userName, userRole) {
    const roleNames = {
        jefe: 'üëî Jefe / Administrador',
        repartidor: 'üöö Repartidor',
        vendedor: 'üíº Vendedor',
        contabilidad: 'üìä Contabilidad y Log√≠stica'
    };
    
    // Actualizar informaci√≥n del usuario en el modal
    document.getElementById('permissions-user-name').textContent = userName;
    document.getElementById('permissions-user-role').textContent = roleNames[userRole];
    document.getElementById('permissions-user-email').textContent = userName.toLowerCase().replace(' ', '') + '@empresa.com';
    
    // Cargar permisos predeterminados seg√∫n el rol
    loadPermissionsByRole(userRole);
    
    // Mostrar modal
    document.getElementById('permissions-modal').style.display = 'flex';
}

// Funci√≥n para cerrar modal de permisos
function closePermissionsModal() {
    document.getElementById('permissions-modal').style.display = 'none';
}

// Funci√≥n para cargar permisos seg√∫n el rol
function loadPermissionsByRole(role) {
    // Obtener todos los checkboxes del modal
    const checkboxes = document.querySelectorAll('#permissions-modal input[type="checkbox"]');
    
    // Permisos por rol (√≠ndices de los checkboxes)
    const rolePermissions = {
        jefe: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14], // Todos
        repartidor: [0, 1, 2, 3, 5, 6, 7, 8, 9, 10, 13, 14], // Sin eliminar, sin finanzas
        vendedor: [0, 1, 2, 3, 5, 12, 13, 14], // Solo clientes y export
        contabilidad: [0, 1, 6, 10, 11, 12, 13, 14] // Solo lectura + reportes
    };
    
    // Resetear todos los checkboxes
    checkboxes.forEach((checkbox, index) => {
        checkbox.checked = rolePermissions[role].includes(index);
    });
}

// Funci√≥n para guardar cambios de permisos
function savePermissions() {
    const userName = document.getElementById('permissions-user-name').textContent;
    const checkboxes = document.querySelectorAll('#permissions-modal input[type="checkbox"]');
    
    // Contar permisos activos
    const activePermissions = Array.from(checkboxes).filter(cb => cb.checked).length;
    const totalPermissions = checkboxes.length;
    
    // Guardar en localStorage (simulaci√≥n)
    // En producci√≥n, esto har√≠a una llamada al backend
    const permissionsData = {
        user: userName,
        permissions: Array.from(checkboxes).map(cb => cb.checked),
        lastModified: new Date().toISOString(),
        modifiedBy: 'Jorge Garc√≠a (Jefe)'
    };
    
    localStorage.setItem(`permissions_${userName}`, JSON.stringify(permissionsData));
    
    // Cerrar modal
    closePermissionsModal();
    
    // Mostrar confirmaci√≥n
    alert(
        `‚úÖ Permisos actualizados exitosamente\n\n` +
        `üë§ Usuario: ${userName}\n` +
        `üîì Permisos activos: ${activePermissions} de ${totalPermissions}\n\n` +
        `Los cambios se aplicar√°n la pr√≥xima vez que el usuario inicie sesi√≥n.`
    );
    
    // Log de auditor√≠a
    logPermissionChange(userName, activePermissions);
}

// Funci√≥n para registrar cambios de permisos
function logPermissionChange(userName, permissionCount) {
    const logs = JSON.parse(localStorage.getItem('permissionLogs') || '[]');
    logs.unshift({
        action: 'permission_update',
        targetUser: userName,
        permissionCount: permissionCount,
        modifiedBy: 'Jorge Garc√≠a',
        timestamp: new Date().toISOString()
    });
    
    // Mantener solo los √∫ltimos 50 registros
    if (logs.length > 50) {
        logs.splice(50);
    }
    
    localStorage.setItem('permissionLogs', JSON.stringify(logs));
}

// ============================================
// FILTRADO DE CLIENTES
// ============================================
function filterClientsList() {
    const searchTerm = document.getElementById('search-clients').value.toLowerCase();
    const cards = document.querySelectorAll('#list-screen .client-card');

    cards.forEach(card => {
        const name = (card.dataset.name || '').toLowerCase();
        const dni = (card.dataset.dni || '').toLowerCase();
        const zone = (card.dataset.zone || '').toLowerCase();

        card.style.display = (name.includes(searchTerm) || dni.includes(searchTerm) || zone.includes(searchTerm)) ? '' : 'none';
    });
}

function showScreen(screenId) {
    // Hide all screens
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    
    // Show selected screen
    document.getElementById(screenId).classList.add('active');
    
    // Load data for specific screens
    if (screenId === 'accounts-receivable-screen') {
        loadAccountsReceivable();
    }
    
    // Scroll to top
    window.scrollTo(0, 0);
}

// Funci√≥n para capturar ubicaci√≥n GPS
function captureLocation(button) {
    if (!navigator.geolocation) {
        alert('Tu navegador no soporta geolocalizaci√≥n');
        return;
    }
    
    // Cambiar texto del bot√≥n mientras se obtiene
    const originalHTML = button.innerHTML;
    button.innerHTML = `
        <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span class="font-medium">Obteniendo ubicaci√≥n...</span>
    `;
    button.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            // √âxito: mostrar coordenadas
            document.getElementById('lat-value').textContent = position.coords.latitude.toFixed(6);
            document.getElementById('lng-value').textContent = position.coords.longitude.toFixed(6);
            document.getElementById('location-indicator').classList.remove('hidden');
            
            // Restaurar bot√≥n
            button.innerHTML = originalHTML;
            button.disabled = false;
            
            // Mensaje de √©xito
            alert('‚úÖ Ubicaci√≥n capturada con √©xito');
        },
        function(error) {
            // Error
            button.innerHTML = originalHTML;
            button.disabled = false;
            
            let errorMsg = 'No se pudo obtener la ubicaci√≥n';
            if (error.code === 1) {
                errorMsg = 'Permiso de ubicaci√≥n denegado. Por favor, permite el acceso a tu ubicaci√≥n.';
            } else if (error.code === 2) {
                errorMsg = 'Ubicaci√≥n no disponible. Verifica tu conexi√≥n GPS.';
            } else if (error.code === 3) {
                errorMsg = 'Tiempo de espera agotado. Intenta nuevamente.';
            }
            alert('‚ùå ' + errorMsg);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// Funci√≥n para abrir el selector de mapa
function openMapPicker() {
    document.getElementById('map-picker-screen').style.display = 'flex';
}

// Funci√≥n para cerrar el selector de mapa
function closeMapPicker() {
    document.getElementById('map-picker-screen').style.display = 'none';
}

// Funci√≥n para confirmar ubicaci√≥n del mapa
function confirmLocation() {
    // Simular captura de coordenadas del centro del mapa
    const lat = (-12.0464 + (Math.random() - 0.5) * 0.01).toFixed(6);
    const lng = (-77.0428 + (Math.random() - 0.5) * 0.01).toFixed(6);
    
    document.getElementById('lat-value').textContent = lat;
    document.getElementById('lng-value').textContent = lng;
    document.getElementById('location-indicator').classList.remove('hidden');
    
    closeMapPicker();
    alert('‚úÖ Ubicaci√≥n seleccionada del mapa');
}

// Funci√≥n para limpiar ubicaci√≥n
function clearLocation() {
    document.getElementById('location-indicator').classList.add('hidden');
}

// Funci√≥n para alternar prioridad de entrega
function togglePriority(button) {
    if (button.textContent === '‚≠ê') {
        // Cambiar a no prioritario
        button.textContent = '‚òÜ';
        button.classList.remove('text-yellow-500');
        button.classList.add('text-gray-300', 'hover:text-yellow-500');
        
        // Cambiar el borde del contenedor
        const card = button.closest('.bg-white');
        card.classList.remove('border-red-500', 'shadow-md');
        card.classList.add('border-gray-300', 'shadow');
        
        alert('‚úì Prioridad removida');
    } else {
        // Cambiar a prioritario
        button.textContent = '‚≠ê';
        button.classList.add('text-yellow-500');
        button.classList.remove('text-gray-300', 'hover:text-yellow-500');
        
        // Cambiar el borde del contenedor
        const card = button.closest('.bg-white');
        card.classList.add('border-red-500', 'shadow-md');
        card.classList.remove('border-gray-300', 'shadow');
        
        alert('‚≠ê Marcado como prioritario');
    }
}

// Funci√≥n para remover de la lista de reparto
function removeFromDelivery(button) {
    const card = button.closest('.bg-white');
    const clientName = card.querySelector('h3').textContent;
    
    if (confirm(`¬øEst√°s seguro de remover a ${clientName} de la lista de reparto?`)) {
        card.style.transition = 'all 0.3s ease';
        card.style.transform = 'translateX(100%)';
        card.style.opacity = '0';
        
        setTimeout(() => {
            card.remove();
            alert('‚úì Cliente removido de la lista de reparto');
        }, 300);
    }
}

// Funci√≥n para abrir modal de agregar a reparto
// Variables globales para el reparto
let selectedClientsForDelivery = new Set();
let deliveryListClients = [];

// Funci√≥n para guardar nuevo cliente
function saveNewClient() {
    console.log('üíæ Guardando nuevo cliente...');
    
    // Obtener valores del formulario
    const dni = document.getElementById('client-dni').value.trim();
    const name = document.getElementById('client-name').value.trim();
    const phone = document.getElementById('client-phone').value.trim();
    const zone = document.getElementById('client-zone').value;
    
    // Validar campos requeridos
    if (!name) {
        alert('‚ö†Ô∏è El nombre es obligatorio');
        document.getElementById('client-name').focus();
        return;
    }
    
    if (!dni) {
        alert('‚ö†Ô∏è El DNI es obligatorio');
        document.getElementById('client-dni').focus();
        return;
    }
    
    if (dni.length !== 8 || !/^\d+$/.test(dni)) {
        alert('‚ö†Ô∏è El DNI debe tener 8 d√≠gitos num√©ricos');
        document.getElementById('client-dni').focus();
        return;
    }
    
    // Crear objeto del cliente
    const clientData = {
        name: name,
        dni: dni,
        phones: phone ? [phone] : [],
        zone: zone !== 'Selecciona una zona' ? zone : '',
        addresses: [],
        email: '',
        contacto: name,
        referencia: ''
    };
    
    // Guardar en la empresa
    const success = addClientToCompany(clientData);
    
    if (success) {
        // Limpiar formulario
        document.getElementById('client-dni').value = '';
        document.getElementById('client-name').value = '';
        document.getElementById('client-phone').value = '';
        document.getElementById('client-zone').value = 'Selecciona una zona';
        
        // Mostrar confirmaci√≥n
        alert(`‚úÖ Cliente guardado exitosamente\n\nüë§ ${name}\nüìû ${phone || 'Sin tel√©fono'}\nüìç ${zone || 'Sin zona'}\n\n¬°Ya est√° disponible en tu lista!`);
        
        // Ir a la lista de clientes
        showScreen('list-screen');
        
        console.log('‚úÖ Cliente guardado:', clientData);
    }
}

function openAddToDelivery() {
    console.log('üì¶ Abriendo selector de clientes para reparto...');
    
    // Resetear selecci√≥n
    selectedClientsForDelivery.clear();
    updateSelectedCount();
    
    // Cargar clientes
    loadClientsForDelivery();
    
    // Mostrar modal
    document.getElementById('add-to-delivery-modal').style.display = 'flex';
}

function closeAddToDeliveryModal() {
    document.getElementById('add-to-delivery-modal').style.display = 'none';
    selectedClientsForDelivery.clear();
}

function loadClientsForDelivery() {
    console.log('üìã Cargando clientes...');
    
    // Obtener clientes
    const clientsKey = currentCompany?.id ? `${currentCompany.id}_clients` : 'clients';
    const clients = JSON.parse(localStorage.getItem(clientsKey) || '[]');
    
    if (clients.length === 0) {
        document.getElementById('clients-list-delivery').innerHTML = `
            <div class="text-center py-12">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">No hay clientes</h3>
                <p class="text-sm text-gray-500 mb-4">Agrega clientes primero para programar entregas</p>
                <button onclick="closeAddToDeliveryModal(); showScreen('add-client-screen')" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                    Agregar Cliente
                </button>
            </div>
        `;
        return;
    }
    
    // Renderizar lista
    renderClientsForDelivery(clients);
    console.log(`‚úÖ ${clients.length} clientes cargados`);
}

function renderClientsForDelivery(clients) {
    const container = document.getElementById('clients-list-delivery');
    
    container.innerHTML = clients.map(client => {
        const initials = client.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const phone = Array.isArray(client.phones) ? client.phones[0] : client.phones;
        const address = Array.isArray(client.addresses) ? client.addresses[0] : client.addresses;
        
        return `
            <label class="client-delivery-item flex items-center gap-3 p-3 bg-white border-2 border-gray-200 rounded-lg cursor-pointer hover:border-orange-400 transition-colors" data-client='${JSON.stringify(client).replace(/'/g, "&apos;")}'>
                <input 
                    type="checkbox" 
                    class="w-5 h-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500"
                    onchange="toggleClientSelection(this, '${client.id}')"
                >
                <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white font-bold text-sm">${initials}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-gray-800 truncate">${client.name}</h3>
                    <p class="text-xs text-gray-600">üìû ${phone || 'Sin tel√©fono'}</p>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full">${client.zone || 'Sin zona'}</span>
                    </div>
                </div>
                <div class="text-right flex-shrink-0">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
            </label>
        `;
    }).join('');
}

function toggleClientSelection(checkbox, clientId) {
    if (checkbox.checked) {
        selectedClientsForDelivery.add(clientId);
        checkbox.closest('.client-delivery-item').classList.add('border-orange-500', 'bg-orange-50');
    } else {
        selectedClientsForDelivery.delete(clientId);
        checkbox.closest('.client-delivery-item').classList.remove('border-orange-500', 'bg-orange-50');
    }
    updateSelectedCount();
}

function updateSelectedCount() {
    document.getElementById('selected-count').textContent = selectedClientsForDelivery.size;
}

function selectAllClients() {
    const checkboxes = document.querySelectorAll('#clients-list-delivery input[type="checkbox"]');
    const allSelected = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(checkbox => {
        if (!allSelected) {
            checkbox.checked = true;
            checkbox.dispatchEvent(new Event('change'));
        } else {
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change'));
        }
    });
}

function filterClientsForDelivery() {
    const searchTerm = document.getElementById('search-clients-delivery').value.toLowerCase();
    const items = document.querySelectorAll('.client-delivery-item');
    
    items.forEach(item => {
        const clientData = JSON.parse(item.dataset.client);
        const searchableText = `${clientData.name} ${clientData.dni || ''} ${clientData.zone || ''}`.toLowerCase();
        
        if (searchableText.includes(searchTerm)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function addSelectedClientsToDelivery() {
    if (selectedClientsForDelivery.size === 0) {
        alert('‚ö†Ô∏è Selecciona al menos un cliente');
        return;
    }
    
    // Obtener clientes seleccionados
    const clientsKey = currentCompany?.id ? `${currentCompany.id}_clients` : 'clients';
    const allClients = JSON.parse(localStorage.getItem(clientsKey) || '[]');
    const selectedClients = allClients.filter(c => selectedClientsForDelivery.has(c.id));
    
    console.log(`üì¶ Agregando ${selectedClients.length} clientes al reparto...`);
    
    // Agregar a la lista de reparto
    deliveryListClients = [...deliveryListClients, ...selectedClients];
    
    // Renderizar lista de reparto actualizada
    renderDeliveryList();
    
    // Cerrar modal
    closeAddToDeliveryModal();
    
    // Mostrar confirmaci√≥n
    alert(`‚úÖ ${selectedClients.length} cliente(s) agregado(s) al reparto\n\nüìã Total en el reparto: ${deliveryListClients.length}`);
}

function renderDeliveryList() {
    // Esta funci√≥n renderizar√° la lista en la pantalla de reparto
    // Por ahora solo actualiza el contador
    console.log('üìã Lista de reparto actualizada:', deliveryListClients.length, 'clientes');
    
    // TODO: Actualizar la UI de la pantalla de reparto con los clientes agregados
    // Esto se puede hacer m√°s adelante para mostrar la lista real en lugar de los datos est√°ticos
}

// Funci√≥n para marcar entrega como completada
function markAsDelivered(button, clientName, zone) {
    // Guardar informaci√≥n en variables globales para usar despu√©s
    window.currentDelivery = {
        button: button,
        clientName: clientName,
        zone: zone,
        card: button.closest('.bg-white')
    };
    
    // Abrir modal de detalles
    openDeliveryModal(clientName, zone);
}

// Variables globales para el modal
let deliveryData = {};

// Funci√≥n para abrir modal de detalles de entrega
function openDeliveryModal(clientName, zone) {
    document.getElementById('delivery-details-modal').style.display = 'flex';
    document.getElementById('modal-client-name').textContent = `Cliente: ${clientName}`;
    
    // Establecer hora actual
    const now = new Date();
    const timeString = now.toLocaleString('es-PE', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit', 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    document.getElementById('delivery-time').textContent = timeString;
    
    // Limpiar formulario
    document.getElementById('guia-number').value = '';
    document.getElementById('total-amount').value = '';
    document.getElementById('paid-amount').value = '';
    document.getElementById('observations').value = '';
    document.getElementById('sale-type').value = '';
    document.getElementById('payment-method').value = '';
    
    // Reset botones
    document.querySelectorAll('.sale-type-btn').forEach(btn => {
        btn.classList.remove('border-green-500', 'bg-green-50');
        btn.classList.add('border-gray-300');
    });
    document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('border-green-500', 'bg-green-50');
        btn.classList.add('border-gray-300');
    });
    
    // Ocultar secci√≥n de saldo
    document.getElementById('balance-section').classList.add('hidden');
    document.getElementById('payment-status').textContent = 'Sin definir';
    document.getElementById('payment-status').className = 'px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-full';
}

// Funci√≥n para cerrar modal
function closeDeliveryModal() {
    document.getElementById('delivery-details-modal').style.display = 'none';
}

// Funci√≥n para seleccionar tipo de venta
function selectSaleType(type) {
    document.getElementById('sale-type').value = type;
    
    // Reset todos los botones
    document.querySelectorAll('.sale-type-btn').forEach(btn => {
        btn.classList.remove('border-green-500', 'bg-green-50');
        btn.classList.add('border-gray-300');
    });
    
    // Activar el seleccionado
    const selectedBtn = document.getElementById(`btn-${type}`);
    selectedBtn.classList.remove('border-gray-300');
    selectedBtn.classList.add('border-green-500', 'bg-green-50');
    
    // ============================================
    // L√ìGICA: SI ES CR√âDITO, DESHABILITAR PAGOS
    // ============================================
    const paymentMethodSection = document.querySelector('#payment-method').closest('div');
    const paidAmountInput = document.getElementById('paid-amount');
    const paymentMethodBtns = document.querySelectorAll('.payment-method-btn');
    
    if (type === 'credito') {
        // CR√âDITO: No se paga nada ahora
        console.log('üí≥ Venta a CR√âDITO seleccionada - Deshabilitando campos de pago');
        
        // Deshabilitar m√©todo de pago
        paymentMethodBtns.forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.classList.remove('hover:border-green-500');
        });
        
        // Deshabilitar monto pagado
        paidAmountInput.disabled = true;
        paidAmountInput.value = '0';
        paidAmountInput.classList.add('bg-gray-100', 'cursor-not-allowed');
        
        // Limpiar m√©todo de pago
        document.getElementById('payment-method').value = '';
        document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.classList.remove('border-green-500', 'bg-green-50');
            btn.classList.add('border-gray-300');
        });
        
        // Mostrar mensaje informativo
        if (!document.getElementById('credit-info-msg')) {
            const infoMsg = document.createElement('div');
            infoMsg.id = 'credit-info-msg';
            infoMsg.className = 'mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg';
            infoMsg.innerHTML = `
                <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-sm text-blue-800">
                        <strong>Venta a cr√©dito:</strong> El cliente no paga nada en este momento. 
                        Solo se registra la entrega y foto de evidencia.
                    </p>
                </div>
            `;
            paidAmountInput.parentElement.appendChild(infoMsg);
        }
        
    } else {
        // CONTADO: Se paga ahora
        console.log('üíµ Venta al CONTADO seleccionada - Habilitando campos de pago');
        
        // Habilitar m√©todo de pago
        paymentMethodBtns.forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.classList.add('hover:border-green-500');
        });
        
        // Habilitar monto pagado
        paidAmountInput.disabled = false;
        paidAmountInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
        
        // Remover mensaje informativo
        const infoMsg = document.getElementById('credit-info-msg');
        if (infoMsg) {
            infoMsg.remove();
        }
    }
    
    calculateBalance();
}

// Funci√≥n para seleccionar m√©todo de pago
function selectPaymentMethod(method) {
    document.getElementById('payment-method').value = method;
    
    // Reset todos los botones
    document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('border-green-500', 'bg-green-50');
        btn.classList.add('border-gray-300');
    });
    
    // Activar el seleccionado
    const selectedBtn = document.getElementById(`btn-${method}`);
    selectedBtn.classList.remove('border-gray-300');
    selectedBtn.classList.add('border-green-500', 'bg-green-50');
}

// Funci√≥n para calcular saldo pendiente
function calculateBalance() {
    const total = parseFloat(document.getElementById('total-amount').value) || 0;
    const paid = parseFloat(document.getElementById('paid-amount').value) || 0;
    const balance = total - paid;
    
    if (total > 0 && paid >= 0) {
        if (balance > 0) {
            document.getElementById('balance-section').classList.remove('hidden');
            document.getElementById('balance-amount').textContent = `S/. ${balance.toFixed(2)}`;
            
            // Actualizar estado
            document.getElementById('payment-status').textContent = 'Pago Parcial';
            document.getElementById('payment-status').className = 'px-3 py-1 bg-amber-100 text-amber-700 text-sm font-medium rounded-full';
        } else if (balance === 0 && paid > 0) {
            document.getElementById('balance-section').classList.add('hidden');
            
            // Actualizar estado
            document.getElementById('payment-status').textContent = 'Pagado Completo';
            document.getElementById('payment-status').className = 'px-3 py-1 bg-green-100 text-green-700 text-sm font-medium rounded-full';
        } else {
            document.getElementById('balance-section').classList.add('hidden');
            document.getElementById('payment-status').textContent = 'Sin definir';
            document.getElementById('payment-status').className = 'px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-full';
        }
    } else {
        document.getElementById('balance-section').classList.add('hidden');
        document.getElementById('payment-status').textContent = 'Sin definir';
        document.getElementById('payment-status').className = 'px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-full';
    }
}

// Funci√≥n para guardar detalles de entrega
function saveDeliveryDetails() {
    const guiaNumber = document.getElementById('guia-number').value;
    const totalAmount = document.getElementById('total-amount').value;
    const paidAmount = document.getElementById('paid-amount').value;
    const saleType = document.getElementById('sale-type').value;
    const paymentMethod = document.getElementById('payment-method').value;
    const observations = document.getElementById('observations').value;
    
    // ============================================
    // VALIDACI√ìN SEG√öN TIPO DE VENTA
    // ============================================
    if (!guiaNumber || !totalAmount || !saleType) {
        alert('‚ö†Ô∏è Por favor completa los campos obligatorios:\n- N√∫mero de Gu√≠a\n- Importe Total\n- Tipo de Venta');
        return;
    }
    
    // Si es CONTADO, validar m√©todo de pago y monto
    if (saleType === 'contado') {
        if (!paymentMethod) {
            alert('‚ö†Ô∏è Para venta al CONTADO, debes seleccionar el m√©todo de pago');
            return;
        }
        if (!paidAmount || parseFloat(paidAmount) === 0) {
            alert('‚ö†Ô∏è Para venta al CONTADO, debes ingresar el monto pagado');
            return;
        }
    }
    
    const total = parseFloat(totalAmount);
    const paid = saleType === 'credito' ? 0 : parseFloat(paidAmount); // Cr√©dito = 0 pagado
    const balance = total - paid;
    
    // Guardar datos de la entrega
    const deliveryRecord = {
        cliente: window.currentDelivery.clientName,
        zona: window.currentDelivery.zone,
        guia: guiaNumber,
        importeTotal: total,
        montoPagado: paid,
        saldoPendiente: balance,
        tipoVenta: saleType === 'contado' ? 'Contado' : 'Cr√©dito',
        metodoPago: saleType === 'credito' ? 'Cr√©dito' : (paymentMethod.charAt(0).toUpperCase() + paymentMethod.slice(1)),
        estadoPago: saleType === 'credito' ? 'Pendiente (Cr√©dito)' : (balance > 0 ? 'Pago Parcial' : 'Pagado Completo'),
        observaciones: observations,
        photo: currentDeliveryPhoto ? currentDeliveryPhoto.storage : null, // Versi√≥n optimizada para BD
        fecha: new Date().toLocaleDateString('es-PE'),
        hora: new Date().toLocaleTimeString('es-PE'),
        repartidor: 'Repartidor 1'
    };
    
    // Guardar versi√≥n WhatsApp temporalmente (para env√≠o)
    const photoForWhatsApp = currentDeliveryPhoto ? currentDeliveryPhoto.whatsapp : null;
    
    // ============================================
    // OPCI√ìN: NO GUARDAR FOTO EN LOCALSTORAGE
    // Para ahorrar espacio, solo enviamos a WhatsApp
    // ============================================
    const SAVE_PHOTO_IN_STORAGE = false; // ‚Üê Cambiar a true para guardar fotos
    
    if (!SAVE_PHOTO_IN_STORAGE && deliveryRecord.photo) {
        console.log('üì∏ Modo: Solo env√≠o a WhatsApp (no guardar foto)');
        deliveryRecord.photo = null; // No guardar foto en localStorage
        deliveryRecord.photoSent = true; // Marcar que se envi√≥
    }
    
    // Guardar en localStorage (simulando base de datos)
    try {
        let deliveries = JSON.parse(localStorage.getItem('deliveries') || '[]');
        deliveries.push(deliveryRecord);
        localStorage.setItem('deliveries', JSON.stringify(deliveries));
        console.log('‚úÖ Entrega guardada en localStorage');
    } catch (error) {
        console.error('‚ö†Ô∏è Error guardando en localStorage:', error);
        if (error.name === 'QuotaExceededError') {
            alert('‚ö†Ô∏è ADVERTENCIA: Almacenamiento lleno\n\nLa foto es muy grande para localStorage.\n\nSe enviar√° a WhatsApp, pero no se guardar√° localmente.\n\nüí° Soluci√≥n: Migrar a Supabase para almacenamiento ilimitado.');
        }
    }
    
    // Resetear foto despu√©s de guardar
    const photoUsed = currentDeliveryPhoto !== null;
    currentDeliveryPhoto = null;
    document.getElementById('photo-preview').classList.add('hidden');
    document.getElementById('photo-image').src = '';
    document.getElementById('photo-upload').value = '';
    
    // Cerrar modal
    closeDeliveryModal();
    
    // Marcar visualmente como entregado
    const button = window.currentDelivery.button;
    const card = window.currentDelivery.card;
    
    button.disabled = true;
    button.classList.add('opacity-50', 'cursor-not-allowed');
    button.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        Entregado
    `;
    
    card.style.transition = 'all 0.5s ease';
    card.style.backgroundColor = '#f0fdf4';
    card.style.borderColor = '#22c55e';
    
    // Incrementar badge de notificaciones
    const badge = document.getElementById('notification-badge');
    if (badge) {
        const currentCount = parseInt(badge.textContent);
        badge.textContent = currentCount + 1;
        badge.classList.add('animate-bounce');
        setTimeout(() => badge.classList.remove('animate-bounce'), 1000);
    }
    
    // Crear notificaci√≥n
    addNotification(window.currentDelivery.clientName, window.currentDelivery.zone);
    
    // ============================================
    // ENVIAR NOTIFICACI√ìN A WHATSAPP
    // ============================================
    sendWhatsAppNotification(deliveryRecord, photoForWhatsApp);
    
    // Mostrar resumen
    const paymentStatus = balance > 0 ? `‚ö†Ô∏è Saldo pendiente: S/. ${balance.toFixed(2)}` : '‚úÖ Pagado completo';
    const photoMsg = photoForWhatsApp ? '\nüì∏ Foto adjuntada para WhatsApp' : '';
    
    // Guardar datos para reintentar WhatsApp si es necesario
    window.lastDeliveryForWhatsApp = {
        record: deliveryRecord,
        photo: photoForWhatsApp
    };
    
    alert(`‚úÖ ¬°Entrega registrada exitosamente!\n\nüìã Resumen:\n- Gu√≠a: ${guiaNumber}\n- Importe: S/. ${total.toFixed(2)}\n- Pagado: S/. ${paid.toFixed(2)}\n${paymentStatus}\n- M√©todo: ${deliveryRecord.metodoPago}${photoMsg}\n\nüì± Notificaci√≥n enviada a WhatsApp\n\nüí° Si WhatsApp no se abri√≥, verifica que no est√©s bloqueando pop-ups`);
}

// Funci√≥n para reenviar a WhatsApp (si fall√≥ la primera vez)
function resendToWhatsApp() {
    if (!window.lastDeliveryForWhatsApp) {
        alert('‚ö†Ô∏è No hay entrega reciente para enviar');
        return;
    }
    
    console.log('üîÑ Reenviando a WhatsApp...');
    sendWhatsAppNotification(
        window.lastDeliveryForWhatsApp.record,
        window.lastDeliveryForWhatsApp.photo
    );
}

// Funci√≥n para agregar una notificaci√≥n al sistema
function addNotification(clientName, zone) {
    const notificationsList = document.getElementById('notifications-list');
    if (!notificationsList) return;
    
    const now = new Date();
    const timeString = 'Justo ahora';
    
    const notificationHTML = `
        <div class="notification-item bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow p-4 cursor-pointer hover:bg-blue-100 transition-colors animate-slide-in">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="flex items-start justify-between mb-1">
                        <h3 class="font-bold text-gray-800">Entrega Completada</h3>
                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                    </div>
                    <p class="text-sm text-gray-700 mb-1">
                        <strong>${clientName}</strong> - ${zone}
                    </p>
                    <p class="text-xs text-gray-600">
                        Entregado por: Repartidor 1
                    </p>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="text-xs text-gray-500">${timeString}</span>
                        <span class="text-xs text-gray-400">‚Ä¢</span>
                        <span class="text-xs text-green-600 font-medium">‚úì Completado</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Insertar al inicio de la lista
    notificationsList.insertAdjacentHTML('afterbegin', notificationHTML);
    
    // Actualizar contador de no le√≠das
    const unreadCount = document.getElementById('unread-count');
    if (unreadCount) {
        const current = parseInt(unreadCount.textContent);
        unreadCount.textContent = current + 1;
    }
}

// Funci√≥n para limpiar todas las notificaciones
function clearAllNotifications() {
    if (confirm('¬øEst√°s seguro de limpiar todas las notificaciones?')) {
        const notificationsList = document.getElementById('notifications-list');
        if (notificationsList) {
            notificationsList.innerHTML = '';
            document.getElementById('empty-notifications-state').classList.remove('hidden');
        }
        
        // Reset contadores
        const badge = document.getElementById('notification-badge');
        if (badge) badge.textContent = '0';
        
        const unreadCount = document.getElementById('unread-count');
        if (unreadCount) unreadCount.textContent = '0';
        
        alert('‚úì Todas las notificaciones han sido limpiadas');
    }
}

// Funci√≥n para exportar reporte de entregas a Excel
function exportDeliveryReport() {
    const deliveries = JSON.parse(localStorage.getItem('deliveries') || '[]');
    
    if (deliveries.length === 0) {
        alert('‚ö†Ô∏è No hay entregas registradas para exportar.\n\nPrimero debes completar al menos una entrega con sus detalles.');
        return;
    }
    
    // Filtrar entregas del d√≠a actual
    const today = new Date().toLocaleDateString('es-PE');
    const todayDeliveries = deliveries.filter(d => d.fecha === today);
    
    if (todayDeliveries.length === 0) {
        alert('‚ö†Ô∏è No hay entregas registradas para hoy.\n\nEl reporte se genera con las entregas del d√≠a actual.');
        return;
    }
    
    console.log('üìä Generando reporte Excel...');
    
    // ============================================
    // GENERAR EXCEL USANDO SHEETJS
    // ============================================
    
    // Cargar SheetJS si no est√° cargado
    if (typeof XLSX === 'undefined') {
        console.log('üì¶ Cargando librer√≠a SheetJS...');
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = () => {
            console.log('‚úÖ SheetJS cargado');
            generateExcelReport(todayDeliveries, today);
        };
        document.head.appendChild(script);
    } else {
        generateExcelReport(todayDeliveries, today);
    }
}

function generateExcelReport(todayDeliveries, today) {
    console.log('üìä Creando hoja de Excel...');
    
    // Calcular totales
    let totalImporte = 0;
    let totalPagado = 0;
    let totalPendiente = 0;
    
    todayDeliveries.forEach(delivery => {
        totalImporte += delivery.importeTotal;
        totalPagado += delivery.montoPagado;
        totalPendiente += delivery.saldoPendiente;
    });
    
    // Crear datos para Excel
    const excelData = [];
    
    // Encabezados
    excelData.push([
        'Fecha',
        'Hora',
        'Cliente',
        'Zona',
        'N¬∫ Gu√≠a',
        'Importe Total (S/.)',
        'Monto Pagado (S/.)',
        'Saldo Pendiente (S/.)',
        'Tipo Venta',
        'M√©todo Pago',
        'Estado Pago',
        'Repartidor',
        'Observaciones'
    ]);
    
    // Datos de entregas
    todayDeliveries.forEach(delivery => {
        excelData.push([
            delivery.fecha,
            delivery.hora,
            delivery.cliente,
            delivery.zona,
            delivery.guia,
            delivery.importeTotal,
            delivery.montoPagado,
            delivery.saldoPendiente,
            delivery.tipoVenta,
            delivery.metodoPago,
            delivery.estadoPago,
            delivery.repartidor,
            delivery.observaciones || '-'
        ]);
    });
    
    // Fila vac√≠a
    excelData.push([]);
    
    // Totales
    excelData.push([
        '',
        '',
        'TOTALES',
        '',
        '',
        totalImporte,
        totalPagado,
        totalPendiente,
        '',
        '',
        '',
        '',
        ''
    ]);
    
    // Crear libro de Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // Ajustar anchos de columna
    ws['!cols'] = [
        { wch: 12 },  // Fecha
        { wch: 10 },  // Hora
        { wch: 20 },  // Cliente
        { wch: 20 },  // Zona
        { wch: 15 },  // Gu√≠a
        { wch: 18 },  // Importe
        { wch: 18 },  // Pagado
        { wch: 18 },  // Pendiente
        { wch: 12 },  // Tipo Venta
        { wch: 15 },  // M√©todo
        { wch: 18 },  // Estado
        { wch: 18 },  // Repartidor
        { wch: 30 }   // Observaciones
    ];
    
    // Aplicar estilos a encabezados
    const headerStyle = {
        font: { bold: true, color: { rgb: "FFFFFF" } },
        fill: { fgColor: { rgb: "4472C4" } },
        alignment: { horizontal: "center", vertical: "center" }
    };
    
    // Aplicar estilo a la fila de totales
    const totalRowIndex = excelData.length - 1;
    
    // Agregar hoja al libro
    XLSX.utils.book_append_sheet(wb, ws, "Entregas");
    
    // Generar archivo Excel
    const fileName = `Reporte_Entregas_${today.replace(/\//g, '-')}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    console.log('‚úÖ Excel generado:', fileName);
    
    // Mostrar resumen (las variables totalPagado y totalPendiente ya est√°n calculadas arriba)
    alert(`üìä Reporte Excel generado exitosamente\n\nüì¶ Entregas del d√≠a: ${todayDeliveries.length}\nüí∞ Total cobrado: S/. ${totalPagado.toFixed(2)}\n‚ö†Ô∏è Saldo pendiente: S/. ${totalPendiente.toFixed(2)}\n\n‚úÖ Archivo: ${fileName}`);
}

// ============================================
// EXPORTAR CLIENTES A EXCEL
// ============================================
function exportClientsToExcel() {
    console.log('üìä Exportando clientes a Excel...');
    
    // Obtener clientes
    const clientsKey = currentCompany?.id ? `${currentCompany.id}_clients` : 'clients';
    const clients = JSON.parse(localStorage.getItem(clientsKey) || '[]');
    
    if (clients.length === 0) {
        alert('‚ö†Ô∏è No hay clientes para exportar\n\nRegistra algunos clientes primero.');
        return;
    }
    
    // Cargar SheetJS si no est√° cargado
    if (typeof XLSX === 'undefined') {
        console.log('üì¶ Cargando SheetJS...');
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = () => {
            console.log('‚úÖ SheetJS cargado');
            generateClientsExcel(clients);
        };
        document.head.appendChild(script);
    } else {
        generateClientsExcel(clients);
    }
}

function generateClientsExcel(clients) {
    console.log('üìä Generando Excel de clientes...');
    
    // Crear datos para Excel
    const excelData = [];
    
    // Encabezados
    excelData.push([
        'ID',
        'Nombre',
        'DNI',
        'Tel√©fono',
        'Email',
        'Direcci√≥n',
        'Zona',
        'Contacto',
        'Referencia'
    ]);
    
    // Datos de clientes
    clients.forEach(client => {
        excelData.push([
            client.id || '',
            client.name || '',
            client.dni || '',
            Array.isArray(client.phones) ? client.phones.join(', ') : (client.phones || ''),
            client.email || '',
            Array.isArray(client.addresses) ? client.addresses.join(' | ') : (client.addresses || ''),
            client.zone || '',
            client.contacto || client.name || '',
            client.referencia || ''
        ]);
    });
    
    // Crear libro de Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // Ajustar ancho de columnas
    ws['!cols'] = [
        { wch: 15 },  // ID
        { wch: 25 },  // Nombre
        { wch: 12 },  // DNI
        { wch: 15 },  // Tel√©fono
        { wch: 30 },  // Email
        { wch: 40 },  // Direcci√≥n
        { wch: 20 },  // Zona
        { wch: 25 },  // Contacto
        { wch: 40 }   // Referencia
    ];
    
    // Agregar hoja al libro
    XLSX.utils.book_append_sheet(wb, ws, "Clientes");
    
    // Generar archivo
    const today = new Date().toLocaleDateString('es-PE').replace(/\//g, '-');
    const fileName = `Clientes_${currentCompany?.name || 'Empresa'}_${today}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    console.log('‚úÖ Excel de clientes generado:', fileName);
    
    // Mostrar resumen
    alert(`üìä Clientes exportados exitosamente\n\nüë• Total clientes: ${clients.length}\nüìÅ Archivo: ${fileName}\n\n‚úÖ Descarga iniciada`);
}

// ============================================
// CUENTAS POR COBRAR
// ============================================

// Cargar cuentas por cobrar
function loadAccountsReceivable() {
    console.log('üí∞ Cargando cuentas por cobrar...');
    
    // Obtener todas las entregas
    const deliveries = JSON.parse(localStorage.getItem('deliveries') || '[]');
    
    // Agrupar deudas por cliente
    const debtsByClient = {};
    
    deliveries.forEach(delivery => {
        if (delivery.saldoPendiente > 0) {
            const clientName = delivery.cliente;
            
            if (!debtsByClient[clientName]) {
                debtsByClient[clientName] = {
                    cliente: clientName,
                    zona: delivery.zona || 'Sin zona',
                    totalDeuda: 0,
                    entregas: []
                };
            }
            
            debtsByClient[clientName].totalDeuda += delivery.saldoPendiente;
            debtsByClient[clientName].entregas.push({
                guia: delivery.guia,
                fecha: delivery.fecha,
                importeTotal: delivery.importeTotal,
                montoPagado: delivery.montoPagado,
                saldoPendiente: delivery.saldoPendiente,
                observaciones: delivery.observaciones
            });
        }
    });
    
    // Convertir a array y ordenar por deuda (mayor a menor)
    const debtorsArray = Object.values(debtsByClient).sort((a, b) => b.totalDeuda - a.totalDeuda);
    
    // Calcular totales
    const totalDebt = debtorsArray.reduce((sum, debtor) => sum + debtor.totalDeuda, 0);
    const totalDebtors = debtorsArray.length;
    
    // Actualizar UI
    document.getElementById('total-debt').textContent = `S/. ${totalDebt.toFixed(2)}`;
    document.getElementById('total-debtors').textContent = totalDebtors;
    
    // Renderizar lista
    renderDebtorsList(debtorsArray);
    
    console.log(`‚úÖ ${totalDebtors} clientes con deuda total de S/. ${totalDebt.toFixed(2)}`);
}

// Renderizar lista de deudores
function renderDebtorsList(debtors) {
    const container = document.getElementById('debtors-list');
    
    if (debtors.length === 0) {
        container.innerHTML = `
            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-8 text-center">
                <svg class="w-16 h-16 text-green-600 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-lg font-bold text-green-800 mb-2">¬°Excelente! Sin deudas pendientes</h3>
                <p class="text-sm text-green-700">Todos los pagos est√°n al d√≠a</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = debtors.map(debtor => `
        <div class="bg-white rounded-lg shadow-md border-l-4 border-red-500 p-4">
            <div class="flex items-start justify-between mb-3">
                <div class="flex items-start gap-3 flex-1">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-red-600 font-bold text-lg">${debtor.cliente.substring(0, 2).toUpperCase()}</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800 text-lg">${debtor.cliente}</h3>
                        <p class="text-sm text-gray-600"><span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">${debtor.zona}</span></p>
                        <div class="mt-2">
                            <p class="text-sm text-red-600 font-semibold">üí∞ Debe: S/. ${debtor.totalDeuda.toFixed(2)}</p>
                            <p class="text-xs text-gray-500">${debtor.entregas.length} entrega(s) pendiente(s)</p>
                        </div>
                    </div>
                </div>
                <button onclick="toggleDebtDetails('debt-${debtor.cliente.replace(/\s/g, '_')}')" class="text-blue-600 hover:text-blue-700">
                    <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Detalles de entregas -->
            <div id="debt-${debtor.cliente.replace(/\s/g, '_')}" class="hidden mt-3 pt-3 border-t border-gray-200 space-y-2">
                ${debtor.entregas.map(entrega => `
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-sm font-semibold text-gray-700">üì¶ ${entrega.guia}</p>
                                <p class="text-xs text-gray-600">üìÖ ${entrega.fecha}</p>
                            </div>
                            <span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full font-semibold">
                                Debe: S/. ${entrega.saldoPendiente.toFixed(2)}
                            </span>
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                            <p>üí∞ Total: S/. ${entrega.importeTotal.toFixed(2)}</p>
                            <p>‚úÖ Pagado: S/. ${entrega.montoPagado.toFixed(2)}</p>
                            ${entrega.observaciones ? `<p class="text-orange-600">üìù ${entrega.observaciones}</p>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

// Toggle detalles de deuda
function toggleDebtDetails(debtId) {
    const detailsDiv = document.getElementById(debtId);
    const button = event.target.closest('button');
    const svg = button.querySelector('svg');
    
    if (detailsDiv.classList.contains('hidden')) {
        detailsDiv.classList.remove('hidden');
        svg.style.transform = 'rotate(180deg)';
    } else {
        detailsDiv.classList.add('hidden');
        svg.style.transform = 'rotate(0deg)';
    }
}

// Exportar cuentas por cobrar a Excel
function exportAccountsReceivableToExcel() {
    console.log('üìä Exportando cuentas por cobrar a Excel...');
    
    // Obtener todas las entregas con saldo pendiente
    const deliveries = JSON.parse(localStorage.getItem('deliveries') || '[]');
    const pendingDeliveries = deliveries.filter(d => d.saldoPendiente > 0);
    
    if (pendingDeliveries.length === 0) {
        alert('‚úÖ No hay cuentas por cobrar\n\nTodos los pagos est√°n al d√≠a.');
        return;
    }
    
    // Cargar SheetJS si no est√° cargado
    if (typeof XLSX === 'undefined') {
        console.log('üì¶ Cargando SheetJS...');
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = () => {
            console.log('‚úÖ SheetJS cargado');
            generateAccountsReceivableExcel(pendingDeliveries);
        };
        document.head.appendChild(script);
    } else {
        generateAccountsReceivableExcel(pendingDeliveries);
    }
}

function generateAccountsReceivableExcel(pendingDeliveries) {
    console.log('üìä Generando Excel de cuentas por cobrar...');
    
    // Crear datos para Excel
    const excelData = [];
    
    // Encabezados
    excelData.push([
        'Cliente',
        'Zona',
        'Gu√≠a',
        'Fecha',
        'Importe Total',
        'Monto Pagado',
        'Saldo Pendiente',
        'Tipo Venta',
        'Observaciones'
    ]);
    
    // Datos de entregas pendientes
    let totalDebt = 0;
    pendingDeliveries.forEach(delivery => {
        excelData.push([
            delivery.cliente || '',
            delivery.zona || '',
            delivery.guia || '',
            delivery.fecha || '',
            delivery.importeTotal || 0,
            delivery.montoPagado || 0,
            delivery.saldoPendiente || 0,
            delivery.tipoVenta || '',
            delivery.observaciones || ''
        ]);
        totalDebt += delivery.saldoPendiente || 0;
    });
    
    // Fila vac√≠a
    excelData.push([]);
    
    // Totales
    excelData.push([
        '',
        '',
        '',
        'TOTALES',
        '',
        '',
        totalDebt,
        '',
        ''
    ]);
    
    // Crear libro de Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // Ajustar ancho de columnas
    ws['!cols'] = [
        { wch: 25 },  // Cliente
        { wch: 20 },  // Zona
        { wch: 15 },  // Gu√≠a
        { wch: 12 },  // Fecha
        { wch: 12 },  // Importe Total
        { wch: 12 },  // Monto Pagado
        { wch: 15 },  // Saldo Pendiente
        { wch: 12 },  // Tipo Venta
        { wch: 40 }   // Observaciones
    ];
    
    // Agregar hoja al libro
    XLSX.utils.book_append_sheet(wb, ws, "Cuentas por Cobrar");
    
    // Generar archivo
    const today = new Date().toLocaleDateString('es-PE').replace(/\//g, '-');
    const fileName = `Cuentas_por_Cobrar_${today}.xlsx`;
    XLSX.writeFile(wb, fileName);
    
    console.log('‚úÖ Excel de cuentas por cobrar generado:', fileName);
    
    // Mostrar resumen
    alert(`üìä Cuentas por Cobrar exportadas\n\nüí∞ Total por cobrar: S/. ${totalDebt.toFixed(2)}\nüì¶ Entregas pendientes: ${pendingDeliveries.length}\nüìÅ Archivo: ${fileName}\n\n‚úÖ Descarga iniciada`);
}

// Funci√≥n para alternar detalles de entrega en el historial
function toggleDeliveryDetails(deliveryId) {
    const detailsDiv = document.getElementById(deliveryId);
    const button = event.target.closest('button');
    const svg = button.querySelector('svg');
    
    if (detailsDiv.classList.contains('hidden')) {
        detailsDiv.classList.remove('hidden');
        svg.style.transform = 'rotate(180deg)';
    } else {
        detailsDiv.classList.add('hidden');
        svg.style.transform = 'rotate(0deg)';
    }
}

// ============================================
// SISTEMA DE FOTO DE EVIDENCIA
// ============================================

// Variable global para almacenar la foto actual
let currentDeliveryPhoto = null;

// Funci√≥n para capturar foto con la c√°mara
function capturePhoto() {
    // Usar el input file con capture para abrir c√°mara directamente
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment'; // Usar c√°mara trasera en m√≥viles
    
    input.onchange = (e) => {
        handlePhotoUpload(e);
    };
    
    input.click();
}

// Funci√≥n para manejar la subida de foto
// Funci√≥n para manejar la subida de foto
async function handlePhotoUpload(event) {
    const file = event.target.files[0];
    
    if (!file) {
        return;
    }
    
    // ============================================
    // VALIDAR FORMATO DE IMAGEN (TODOS SOPORTADOS)
    // ============================================
    const supportedFormats = [
        'image/jpeg',
        'image/jpg', 
        'image/png',
        'image/gif',
        'image/webp',
        'image/bmp',
        'image/tiff',
        'image/svg+xml',
        'image/heic',
        'image/heif',
        'image/avif'
    ];
    
    const isImage = file.type.startsWith('image/') || supportedFormats.includes(file.type);
    const hasImageExtension = /\.(jpg|jpeg|png|gif|webp|bmp|tiff|tif|svg|heic|heif|avif)$/i.test(file.name);
    
    if (!isImage && !hasImageExtension) {
        alert(`‚ö†Ô∏è Formato no soportado\n\nFormatos aceptados:\n‚úÖ JPG, JPEG, PNG\n‚úÖ GIF, WEBP, BMP\n‚úÖ TIFF, SVG\n‚úÖ HEIC, HEIF, AVIF\n\nTu archivo: ${file.name}`);
        return;
    }
    
    // Validar tama√±o (m√°ximo 20MB - aumentado para soportar m√°s formatos)
    if (file.size > 20 * 1024 * 1024) {
        alert(`‚ö†Ô∏è Archivo demasiado grande\n\nTama√±o m√°ximo: 20 MB\nTu archivo: ${(file.size / 1024 / 1024).toFixed(2)} MB\n\nüí° TIP: Reduce el tama√±o de la imagen antes de subirla`);
        return;
    }
    
    // Mostrar indicador de carga
    showPhotoProcessing();
    
    // Leer la imagen como base64
    const reader = new FileReader();
    
    reader.onload = async (e) => {
        const originalBase64 = e.target.result;
        
        console.log('üì∏ Foto original capturada');
        console.log('   Formato:', file.type || 'Detectado por extensi√≥n');
        console.log('   Nombre:', file.name);
        console.log('   Tama√±o:', (file.size / 1024 / 1024).toFixed(2), 'MB');
        
        try {
            // ============================================
            // CREAR 2 VERSIONES DE LA FOTO
            // ============================================
            
            // Versi√≥n 1: Para guardar en base de datos (optimizada)
            console.log('üîß Comprimiendo versi√≥n para base de datos...');
            const storageVersion = await compressImage(originalBase64, 800, 0.70);
            
            // Versi√≥n 2: Para enviar a WhatsApp (mejor calidad)
            console.log('üîß Comprimiendo versi√≥n para WhatsApp...');
            const whatsappVersion = await compressImage(originalBase64, 1600, 0.85);
            
            // Guardar ambas versiones
            currentDeliveryPhoto = {
                storage: storageVersion,      // 800px, ~150KB, 70% - Para BD
                whatsapp: whatsappVersion,    // 1600px, ~300KB, 85% - Para WhatsApp
                filename: file.name,
                originalSize: file.size,
                originalFormat: file.type || 'image/jpeg',
                timestamp: new Date().toISOString()
            };
            
            // Calcular tama√±os aproximados
            const storageSize = Math.round((storageVersion.length * 3) / 4 / 1024);
            const whatsappSize = Math.round((whatsappVersion.length * 3) / 4 / 1024);
            
            console.log('‚úÖ 2 versiones creadas:');
            console.log('   üì¶ BD: ~' + storageSize + ' KB (800px, 70%)');
            console.log('   üì± WhatsApp: ~' + whatsappSize + ' KB (1600px, 85%)');
            
            // Mostrar preview (recrear HTML completo)
            const previewDiv = document.getElementById('photo-preview');
            if (previewDiv) {
                previewDiv.classList.remove('hidden');
                previewDiv.innerHTML = `
                    <div class="relative">
                        <img id="photo-image" src="${storageVersion}" alt="Evidencia" class="w-full h-48 object-cover rounded-lg border-2 border-gray-300">
                        <button type="button" onclick="removePhoto()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 hover:bg-red-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">‚úÖ Foto capturada (~${storageSize} KB). Se enviar√° con la notificaci√≥n de WhatsApp.</p>
                `;
            }
            
            hidePhotoProcessing();
            
        } catch (error) {
            console.error('‚ùå Error procesando foto:', error);
            console.error('   Tipo:', error.name);
            console.error('   Mensaje:', error.message);
            console.error('   Stack:', error.stack);
            
            alert(`‚ùå Error al procesar la imagen\n\n${error.message}\n\nIntenta:\n1. Usar una imagen m√°s peque√±a\n2. Convertir a JPG antes de subir\n3. Recargar la p√°gina (F5)`);
            hidePhotoProcessing();
            
            // Limpiar el input para permitir reintentar
            document.getElementById('photo-upload').value = '';
        }
    };
    
    reader.onerror = (error) => {
        console.error('‚ùå Error al cargar la imagen:', error);
        alert('‚ùå Error al leer el archivo.\n\nVerifica que:\n‚úÖ El archivo no est√© corrupto\n‚úÖ Tengas permisos de lectura\n‚úÖ El formato sea v√°lido');
        hidePhotoProcessing();
        
        // Limpiar el input
        document.getElementById('photo-upload').value = '';
    };
    
    reader.readAsDataURL(file);
}

// Funci√≥n para comprimir imagen
function compressImage(base64Image, maxWidth, quality) {
    return new Promise((resolve, reject) => {
        try {
            const img = new Image();
            
            img.onload = () => {
                try {
                    console.log('üñºÔ∏è Imagen cargada:', img.width, 'x', img.height);
                    
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Calcular nuevas dimensiones manteniendo aspecto
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    
                    console.log('üìê Nuevas dimensiones:', width, 'x', height);
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    if (!ctx) {
                        throw new Error('No se pudo obtener contexto del canvas');
                    }
                    
                    // Mejorar calidad de renderizado
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // Dibujar imagen redimensionada
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Comprimir a JPEG
                    const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                    
                    console.log('‚úÖ Imagen comprimida exitosamente');
                    
                    resolve(compressedBase64);
                } catch (error) {
                    console.error('‚ùå Error en proceso de compresi√≥n:', error);
                    // Fallback: devolver original
                    resolve(base64Image);
                }
            };
            
            img.onerror = (error) => {
                console.error('‚ùå Error cargando imagen en objeto Image:', error);
                // Fallback: devolver original
                resolve(base64Image);
            };
            
            // Cargar imagen
            img.src = base64Image;
            
        } catch (error) {
            console.error('‚ùå Error general en compressImage:', error);
            // Fallback: devolver original
            resolve(base64Image);
        }
    });
}

// Mostrar indicador de procesamiento
function showPhotoProcessing() {
    const preview = document.getElementById('photo-preview');
    if (preview) {
        preview.classList.remove('hidden');
        preview.innerHTML = `
            <div class="flex items-center justify-center h-48 bg-gray-100 rounded-lg">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3"></div>
                    <p class="text-sm text-gray-600">Procesando foto...</p>
                </div>
            </div>
        `;
    }
}

// Ocultar indicador de procesamiento
function hidePhotoProcessing() {
    // La funci√≥n handlePhotoUpload ya actualiza el preview
}

// Funci√≥n para remover la foto
function removePhoto() {
    currentDeliveryPhoto = null;
    document.getElementById('photo-preview').classList.add('hidden');
    document.getElementById('photo-image').src = '';
    document.getElementById('photo-upload').value = '';
    console.log('üóëÔ∏è Foto removida');
}

// Funci√≥n para comprimir imagen antes de enviar (opcional)
function compressImage(base64Image, maxWidth = 800, quality = 0.7) {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = base64Image;
        
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Redimensionar si es necesario
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Comprimir
            const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
            resolve(compressedBase64);
        };
    });
}

// ============================================
// SISTEMA DE RESUMEN DIARIO AUTOM√ÅTICO
// ============================================

// Configuraci√≥n del resumen diario
const DAILY_SUMMARY_CONFIG = {
    enabled: true,
    sendTime: '20:00', // Hora de env√≠o (formato 24h: HH:MM)
    autoSend: true, // Enviar autom√°ticamente
    includePhotos: true // Incluir contador de fotos
};

// Funci√≥n para generar resumen diario
function generateDailySummary() {
    const today = new Date().toLocaleDateString('es-PE');
    
    // Obtener todas las entregas del d√≠a
    let allDeliveries = JSON.parse(localStorage.getItem('deliveries') || '[]');
    const todayDeliveries = allDeliveries.filter(d => d.fecha === today);
    
    if (todayDeliveries.length === 0) {
        return null;
    }
    
    // Calcular totales
    let totalImporte = 0;
    let totalCobrado = 0;
    let totalPendiente = 0;
    let pagadosCompletos = 0;
    let pagosParciales = 0;
    let conFoto = 0;
    
    // Agrupar por m√©todo de pago
    const porMetodo = {
        'Efectivo': { cantidad: 0, monto: 0 },
        'Yape': { cantidad: 0, monto: 0 },
        'Plin': { cantidad: 0, monto: 0 }
    };
    
    // Agrupar por zona
    const porZona = {};
    
    // Agrupar por repartidor
    const porRepartidor = {};
    
    todayDeliveries.forEach(delivery => {
        // Totales generales
        totalImporte += delivery.importeTotal || 0;
        totalCobrado += delivery.montoPagado || 0;
        totalPendiente += delivery.saldoPendiente || 0;
        
        // Estados de pago
        if (delivery.estadoPago === 'Pagado Completo') pagadosCompletos++;
        if (delivery.estadoPago === 'Pago Parcial') pagosParciales++;
        
        // Fotos
        if (delivery.photo) conFoto++;
        
        // Por m√©todo de pago
        const metodo = delivery.metodoPago || 'Efectivo';
        if (porMetodo[metodo]) {
            porMetodo[metodo].cantidad++;
            porMetodo[metodo].monto += delivery.montoPagado || 0;
        }
        
        // Por zona
        const zona = delivery.zona || 'Sin zona';
        if (!porZona[zona]) {
            porZona[zona] = { cantidad: 0, monto: 0 };
        }
        porZona[zona].cantidad++;
        porZona[zona].monto += delivery.montoPagado || 0;
        
        // Por repartidor
        const repartidor = delivery.repartidor || 'Sin asignar';
        if (!porRepartidor[repartidor]) {
            porRepartidor[repartidor] = { cantidad: 0, monto: 0 };
        }
        porRepartidor[repartidor].cantidad++;
        porRepartidor[repartidor].monto += delivery.montoPagado || 0;
    });
    
    return {
        fecha: today,
        totalEntregas: todayDeliveries.length,
        totalImporte,
        totalCobrado,
        totalPendiente,
        pagadosCompletos,
        pagosParciales,
        conFoto,
        porMetodo,
        porZona,
        porRepartidor,
        deliveries: todayDeliveries
    };
}

// Funci√≥n para formatear resumen diario para WhatsApp
function formatDailySummaryMessage(summary) {
    if (!summary) {
        return null;
    }
    
    const empresa = currentCompany?.name || 'Mi Empresa';
    
    let message = `üìä *RESUMEN DIARIO DE ENTREGAS*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    message += `üè¢ *${empresa}*\n`;
    message += `üìÖ *Fecha:* ${summary.fecha}\n`;
    message += `üïê *Generado:* ${new Date().toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' })}\n\n`;
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üì¶ *RESUMEN GENERAL*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    message += `üì¶ *Total Entregas:* ${summary.totalEntregas}\n`;
    message += `üí∞ *Importe Total:* S/. ${summary.totalImporte.toFixed(2)}\n`;
    message += `‚úÖ *Total Cobrado:* S/. ${summary.totalCobrado.toFixed(2)}\n`;
    message += `‚ö†Ô∏è *Total Pendiente:* S/. ${summary.totalPendiente.toFixed(2)}\n`;
    message += `üì∏ *Con Evidencia:* ${summary.conFoto} entregas\n\n`;
    
    message += `üéØ *ESTADOS DE PAGO*\n`;
    message += `‚úÖ Pagados Completos: ${summary.pagadosCompletos}\n`;
    message += `‚ö†Ô∏è Pagos Parciales: ${summary.pagosParciales}\n\n`;
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üí≥ *POR M√âTODO DE PAGO*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    Object.keys(summary.porMetodo).forEach(metodo => {
        const data = summary.porMetodo[metodo];
        if (data.cantidad > 0) {
            message += `${metodo}: ${data.cantidad} entregas - S/. ${data.monto.toFixed(2)}\n`;
        }
    });
    
    message += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üìç *POR ZONA*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    Object.keys(summary.porZona).forEach(zona => {
        const data = summary.porZona[zona];
        message += `${zona}: ${data.cantidad} entregas - S/. ${data.monto.toFixed(2)}\n`;
    });
    
    message += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üë∑ *POR REPARTIDOR*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    Object.keys(summary.porRepartidor).forEach(repartidor => {
        const data = summary.porRepartidor[repartidor];
        message += `${repartidor}: ${data.cantidad} entregas - S/. ${data.monto.toFixed(2)}\n`;
    });
    
    message += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üìà *EFICIENCIA*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    const porcentajeCobrado = (summary.totalCobrado / summary.totalImporte * 100).toFixed(1);
    message += `üíØ Tasa de Cobro: ${porcentajeCobrado}%\n`;
    message += `üì∏ Evidencia Fotogr√°fica: ${((summary.conFoto / summary.totalEntregas) * 100).toFixed(1)}%\n\n`;
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `ü§ñ Reporte generado autom√°ticamente`;
    
    return message;
}

// Funci√≥n para enviar resumen diario
function sendDailySummary() {
    console.log('üìä Generando resumen diario...');
    
    const summary = generateDailySummary();
    
    if (!summary) {
        console.log('‚ö†Ô∏è No hay entregas para el resumen diario');
        alert('üìä No hay entregas de hoy\n\nEl resumen diario solo incluye entregas del d√≠a actual.\n\nüí° Para generar un resumen:\n1. Registra algunas entregas primero\n2. O usa datos demo: Click "üîß Resetear datos demo"');
        return;
    }
    
    const message = formatDailySummaryMessage(summary);
    
    console.log('üìä Resumen generado:', summary);
    console.log('üìù Mensaje:', message.substring(0, 200) + '...');
    
    // Mostrar preview del resumen antes de enviar
    const confirmSend = confirm(`üìä RESUMEN DIARIO GENERADO\n\n${summary.totalEntregas} entregas de hoy\nTotal cobrado: S/. ${summary.totalCobrado.toFixed(2)}\n\n¬øEnviar a WhatsApp?`);
    
    if (!confirmSend) {
        console.log('‚ùå Usuario cancel√≥ el env√≠o');
        return;
    }
    
    if (WHATSAPP_CONFIG.enabled) {
        sendViaWhatsAppWeb(message);
        console.log('‚úÖ Resumen diario enviado a WhatsApp');
        
        // Guardar que se envi√≥ el resumen
        const today = new Date().toLocaleDateString('es-PE');
        localStorage.setItem(`daily_summary_sent_${today}`, 'true');
    } else {
        alert('‚ö†Ô∏è WhatsApp est√° desactivado\n\nActiva WHATSAPP_CONFIG.enabled = true para enviar');
    }
}

// Funci√≥n para programar env√≠o autom√°tico del resumen
function scheduleDailySummary() {
    if (!DAILY_SUMMARY_CONFIG.enabled || !DAILY_SUMMARY_CONFIG.autoSend) {
        return;
    }
    
    // Verificar cada minuto si es hora de enviar
    setInterval(() => {
        const now = new Date();
        const currentTime = now.toTimeString().substring(0, 5); // HH:MM
        const today = now.toLocaleDateString('es-PE');
        
        // Verificar si es la hora configurada y no se ha enviado hoy
        const alreadySent = localStorage.getItem(`daily_summary_sent_${today}`);
        
        if (currentTime === DAILY_SUMMARY_CONFIG.sendTime && !alreadySent) {
            sendDailySummary();
        }
    }, 60000); // Cada minuto
}

// Iniciar programaci√≥n al cargar
scheduleDailySummary();

// ============================================
// SISTEMA DE NOTIFICACIONES WHATSAPP
// ============================================

// Configuraci√≥n de WhatsApp
const WHATSAPP_CONFIG = {
    enabled: true, // Activar/desactivar notificaciones
    groupNumber: '51923190308', // N√∫mero configurado: +51 923 190 308
    useWhatsAppWeb: true, // true = WhatsApp Web, false = API Business
    // Para API de WhatsApp Business:
    apiToken: '', // Token de tu cuenta de WhatsApp Business API
    apiUrl: 'https://graph.facebook.com/v18.0/', // URL de la API
    phoneNumberId: '' // ID del n√∫mero de tel√©fono
};

// Funci√≥n para enviar notificaci√≥n a WhatsApp
function sendWhatsAppNotification(delivery, photoBase64) {
    console.log('üîî sendWhatsAppNotification llamada');
    console.log('   Config enabled:', WHATSAPP_CONFIG.enabled);
    console.log('   Tiene foto:', !!photoBase64);
    
    if (!WHATSAPP_CONFIG.enabled) {
        console.log('‚ùå Notificaciones de WhatsApp desactivadas');
        alert('‚ö†Ô∏è Notificaciones WhatsApp desactivadas\n\nPara activar, cambia WHATSAPP_CONFIG.enabled = true');
        return;
    }
    
    // Crear mensaje formateado
    const message = formatWhatsAppMessage(delivery);
    console.log('üìù Mensaje formateado:', message.substring(0, 100) + '...');
    
    if (WHATSAPP_CONFIG.useWhatsAppWeb) {
        console.log('üì± Usando WhatsApp Web');
        // OPCI√ìN 1: WhatsApp Web con foto
        sendViaWhatsAppWebWithPhoto(message, photoBase64);
    } else {
        console.log('üîå Usando WhatsApp API');
        // OPCI√ìN 2: API de WhatsApp Business (requiere configuraci√≥n)
        sendViaWhatsAppAPI(message);
    }
}

// Formatear mensaje para WhatsApp
function formatWhatsAppMessage(delivery) {
    const empresa = currentCompany?.name || 'Mi Empresa';
    
    let message = `üöö *ENTREGA COMPLETADA*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    message += `üè¢ *Empresa:* ${empresa}\n`;
    message += `üìÖ *Fecha:* ${delivery.fecha}\n`;
    message += `üïê *Hora:* ${delivery.hora}\n\n`;
    message += `üë§ *Cliente:* ${delivery.cliente}\n`;
    message += `üìç *Zona:* ${delivery.zona}\n`;
    message += `üì¶ *Gu√≠a:* ${delivery.guia}\n`;
    message += `üë∑ *Repartidor:* ${delivery.repartidor}\n\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üí∞ *DETALLES FINANCIEROS*\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    message += `üíµ *Importe Total:* S/. ${delivery.importeTotal.toFixed(2)}\n`;
    message += `üí≥ *M√©todo de Pago:* ${delivery.metodoPago}\n`;
    message += `üè∑Ô∏è *Tipo de Venta:* ${delivery.tipoVenta}\n`;
    message += `‚úÖ *Monto Pagado:* S/. ${delivery.montoPagado.toFixed(2)}\n`;
    
    if (delivery.saldoPendiente > 0) {
        message += `‚ö†Ô∏è *Saldo Pendiente:* S/. ${delivery.saldoPendiente.toFixed(2)}\n`;
        message += `üìä *Estado:* ${delivery.estadoPago}\n`;
    } else {
        message += `‚úÖ *Estado:* ${delivery.estadoPago}\n`;
    }
    
    if (delivery.observaciones) {
        message += `\nüìù *Observaciones:* ${delivery.observaciones}\n`;
    }
    
    // Indicar si hay foto de evidencia
    if (delivery.photo) {
        message += `\nüì∏ *Foto de Evidencia:* ‚úÖ Incluida\n`;
        message += `   (Adjuntar imagen al enviar este mensaje)\n`;
    }
    
    message += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `‚è∞ Registro autom√°tico del sistema`;
    
    return message;
}

// OPCI√ìN 1: Enviar via WhatsApp Web
function sendViaWhatsAppWeb(message) {
    // Codificar mensaje para URL
    const encodedMessage = encodeURIComponent(message);
    
    // Detectar si es m√≥vil
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    // Usar whatsapp:// para abrir la app directamente (m√≥vil y desktop)
    let whatsappUrl = `https://api.whatsapp.com/send?phone=${WHATSAPP_CONFIG.groupNumber}&text=${encodedMessage}`;
    console.log('üì± Abriendo app de WhatsApp directamente');
    
    // Abrir WhatsApp
    window.open(whatsappUrl, '_blank');
    
    console.log('üì± WhatsApp abierto con mensaje preparado');
}

// OPCI√ìN 1B: Enviar via WhatsApp Web CON FOTO
async function sendViaWhatsAppWebWithPhoto(message, photoBase64) {
    console.log('üöÄ Iniciando env√≠o a WhatsApp...');
    console.log('üìù Mensaje:', message);
    console.log('üì∏ Tiene foto:', !!photoBase64);
    
    // ============================================
    // IMPORTANTE: Copiar PRIMERO (mientras hay contexto de usuario)
    // ============================================
    let photoCopied = false;
    if (photoBase64) {
        console.log('üìã Copiando foto al portapapeles...');
        photoCopied = await copyImageToClipboard(photoBase64);
    }
    
    // Codificar mensaje para URL
    const encodedMessage = encodeURIComponent(message);
    
    // ============================================
    // DETECTAR SI ES M√ìVIL O DESKTOP
    // ============================================
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    // Crear URL seg√∫n dispositivo
    let whatsappUrl;
    if (isMobile) {
        // M√ìVIL: Usar wa.me (abre app de WhatsApp)
        whatsappUrl = `https://wa.me/${WHATSAPP_CONFIG.groupNumber}?text=${encodedMessage}`;
        console.log('üì± Dispositivo m√≥vil detectado - Usando wa.me (app nativa)');
    } else {
        // DESKTOP: Usar web.whatsapp.com
        whatsappUrl = `https://web.whatsapp.com/send?phone=${WHATSAPP_CONFIG.groupNumber}&text=${encodedMessage}`;
        console.log('üíª Desktop detectado - Usando WhatsApp Web');
    }
    
    console.log('üîó URL WhatsApp:', whatsappUrl);
    
    // Abrir WhatsApp (app o web seg√∫n dispositivo)
    const whatsappWindow = window.open(whatsappUrl, '_blank');
    
    // Verificar si se bloque√≥ el pop-up
    if (!whatsappWindow || whatsappWindow.closed || typeof whatsappWindow.closed == 'undefined') {
        console.error('‚ùå Pop-up bloqueado por el navegador');
        alert(`‚ö†Ô∏è POP-UP BLOQUEADO\n\nEl navegador bloque√≥ WhatsApp.\n\n‚úÖ SOLUCI√ìN:\n1. Permite pop-ups para este sitio\n2. O copia el mensaje manualmente:\n\n${message}\n\nüì± Env√≠a a: ${WHATSAPP_CONFIG.groupNumber}`);
        return;
    }
    
    console.log('‚úÖ WhatsApp abierto con mensaje preparado');
    
    // Mostrar instrucciones seg√∫n dispositivo
    if (photoBase64) {
        setTimeout(() => {
            let instructions;
            
            if (isMobile) {
                // Instrucciones para M√ìVIL (app de WhatsApp)
                instructions = `‚úÖ WhatsApp App abierto con el mensaje

üì∏ ADJUNTAR FOTO:

1. En WhatsApp, toca el icono üìé (clip)
2. Selecciona "Galer√≠a" o "C√°mara"
3. Elige la foto que acabas de tomar
4. Toca "Enviar" ‚úàÔ∏è

üí° TIP: La foto est√° guardada en tu galer√≠a
La foto est√° en ALTA CALIDAD (1600px, 300KB, 85%)`;
            } else {
                // Instrucciones para DESKTOP
                instructions = photoCopied 
                    ? `‚úÖ WhatsApp Web abierto con el mensaje

üì∏ ‚úÖ FOTO COPIADA AL PORTAPAPELES

AHORA:
1. Ve a WhatsApp Web
2. Presiona Ctrl+V (o Cmd+V en Mac)
3. La foto aparecer√° autom√°ticamente
4. Click en "Enviar" ‚úàÔ∏è

La foto est√° en ALTA CALIDAD (1600px, 300KB, 85%)
WhatsApp la optimizar√° a ~200KB autom√°ticamente.`
                    : `‚úÖ WhatsApp Web abierto con el mensaje

‚ö†Ô∏è La foto se descarg√≥ (portapapeles no disponible)

AHORA:
1. Ve a WhatsApp Web
2. Click en üìé (clip)
3. Selecciona "Fotos y videos"
4. Busca el archivo descargado
5. Enviar`;
            }
            
            alert(instructions);
        }, 1500);
    }
}

// Copiar imagen al portapapeles
async function copyImageToClipboard(base64Image) {
    console.log('üìã Intentando copiar imagen al portapapeles...');
    
    try {
        // Verificar soporte del navegador
        if (!navigator.clipboard) {
            console.warn('‚ö†Ô∏è navigator.clipboard no disponible');
            downloadImage(base64Image, 'evidencia-entrega.jpg');
            return false;
        }
        
        if (!window.ClipboardItem) {
            console.warn('‚ö†Ô∏è ClipboardItem no disponible');
            downloadImage(base64Image, 'evidencia-entrega.jpg');
            return false;
        }
        
        console.log('‚úÖ Navegador soporta Clipboard API');
        
        // Convertir base64 a blob
        console.log('üîÑ Convirtiendo base64 a blob...');
        const response = await fetch(base64Image);
        const blob = await response.blob();
        console.log('‚úÖ Blob creado:', blob.type, blob.size, 'bytes');
        
        // Intentar copiar al portapapeles
        console.log('üìã Escribiendo en portapapeles...');
        await navigator.clipboard.write([
            new ClipboardItem({
                [blob.type]: blob
            })
        ]);
        
        console.log('üìã ‚úÖ Foto copiada al portapapeles exitosamente');
        console.log('   Tipo:', blob.type);
        console.log('   Tama√±o:', Math.round(blob.size / 1024), 'KB');
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Error copiando imagen:', error);
        console.error('   Nombre:', error.name);
        console.error('   Mensaje:', error.message);
        
        // Detectar tipo de error
        if (error.name === 'NotAllowedError') {
            console.error('   Causa: Permisos denegados o contexto de seguridad');
        } else if (error.name === 'TypeError') {
            console.error('   Causa: Tipo de imagen no soportado');
        }
        
        // Fallback: Descargar imagen
        console.log('üíæ Usando fallback: descarga');
        downloadImage(base64Image, 'evidencia-entrega.jpg');
        
        return false;
    }
}

// Descargar imagen como alternativa
function downloadImage(base64Image, filename) {
    const a = document.createElement('a');
    a.href = base64Image;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    console.log('üíæ Foto descargada:', filename);
}

// OPCI√ìN 2: Enviar via API de WhatsApp Business
async function sendViaWhatsAppAPI(message) {
    if (!WHATSAPP_CONFIG.apiToken) {
        console.error('‚ùå API Token no configurado');
        alert('‚ö†Ô∏è Para usar la API de WhatsApp Business, configura tu token en WHATSAPP_CONFIG');
        return;
    }
    
    try {
        const response = await fetch(
            `${WHATSAPP_CONFIG.apiUrl}${WHATSAPP_CONFIG.phoneNumberId}/messages`,
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${WHATSAPP_CONFIG.apiToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    messaging_product: 'whatsapp',
                    to: WHATSAPP_CONFIG.groupNumber,
                    type: 'text',
                    text: {
                        body: message
                    }
                })
            }
        );
        
        if (response.ok) {
            console.log('‚úÖ Mensaje enviado via WhatsApp Business API');
        } else {
            console.error('‚ùå Error al enviar mensaje:', await response.text());
        }
    } catch (error) {
        console.error('‚ùå Error en API de WhatsApp:', error);
    }
}

// Funci√≥n para configurar WhatsApp desde la UI
function openWhatsAppSettings() {
    const currentNumber = WHATSAPP_CONFIG.groupNumber;
    const currentMethod = WHATSAPP_CONFIG.useWhatsAppWeb ? 'WhatsApp Web' : 'API Business';
    
    const instructions = `
üì± CONFIGURAR N√öMERO DE WHATSAPP

M√©todo actual: ${currentMethod}
N√∫mero actual: ${currentNumber}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìã FORMATOS V√ÅLIDOS:

‚úÖ N√∫mero Personal:
   Per√∫: 51987654321
   M√©xico: 5215512345678
   Colombia: 573001234567

‚úÖ N√∫mero de Empresa:
   Mismo formato que arriba

‚ö†Ô∏è Grupos de WhatsApp:
   No soportado directamente
   Usa n√∫mero personal y reenv√≠a al grupo

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Ingresa el nuevo n√∫mero:`;
    
    const newNumber = prompt(instructions, currentNumber);
    
    if (newNumber && newNumber.trim().length >= 10) {
        const cleanNumber = newNumber.trim().replace(/[^0-9]/g, ''); // Limpiar espacios y caracteres
        
        if (cleanNumber.length < 10) {
            alert('‚ùå N√∫mero inv√°lido. Debe tener al menos 10 d√≠gitos.');
            return;
        }
        
        WHATSAPP_CONFIG.groupNumber = cleanNumber;
        localStorage.setItem('whatsapp_group_number', cleanNumber);
        
        console.log('‚úÖ N√∫mero WhatsApp actualizado:', cleanNumber);
        
        alert(
            `‚úÖ CONFIGURACI√ìN ACTUALIZADA\n\n` +
            `üì± N√∫mero: ${cleanNumber}\n\n` +
            `Las notificaciones se enviar√°n a este n√∫mero.\n\n` +
            `üí° TIP: Guarda este n√∫mero en tu WhatsApp\n` +
            `para recibir las notificaciones.`
        );
    } else if (newNumber !== null) {
        alert('‚ö†Ô∏è Configuraci√≥n cancelada o n√∫mero inv√°lido.');
    }
}

// Funci√≥n para formatear n√∫mero de WhatsApp mientras se escribe
function formatWhatsAppNumber(input) {
    // Solo permitir n√∫meros
    let value = input.value.replace(/[^0-9]/g, '');
    input.value = value;
    
    // Dar feedback visual seg√∫n longitud
    if (value.length < 10) {
        input.classList.remove('border-green-500');
        input.classList.add('border-gray-300');
    } else {
        input.classList.remove('border-gray-300');
        input.classList.add('border-green-500');
    }
}

// ============================================
// INICIALIZAR DATOS DEMO
// ============================================
function initializeDemoData() {
    // Solo inicializar si no hay datos
    const existingUsers = localStorage.getItem('users');
    const existingCompanies = localStorage.getItem('companies');
    
    if (!existingUsers || !existingCompanies) {
        console.log('üéÆ Inicializando datos demo...');
        createDemoData();
    } else {
        // Asegurar que el usuario de contabilidad exista en datos anteriores
        const users = JSON.parse(existingUsers);
        if (!users.find(u => u.role === 'contabilidad')) {
            users.push({
                id: 'user_004',
                email: 'contabilidad@empresa.com',
                password: '123456',
                role: 'contabilidad',
                companyId: 'company_demo_001',
                fullname: 'Contabilidad Demo',
                whatsapp: '51923190308',
                created_at: new Date().toISOString()
            });
            localStorage.setItem('users', JSON.stringify(users));
            console.log('‚úÖ Usuario contabilidad agregado a datos existentes');
        }
        console.log('‚úÖ Datos demo ya existen');
    }
}

// Funci√≥n para forzar reset de datos demo
function resetDemoData() {
    if (confirm('‚ö†Ô∏è ¬øResetear todos los datos demo?\n\nEsto borrar√°:\n- Usuarios\n- Empresas\n- Clientes\n- Entregas\n\n¬øContinuar?')) {
        console.log('üîÑ Reseteando datos demo...');
        localStorage.removeItem('users');
        localStorage.removeItem('companies');
        localStorage.removeItem('clients');
        localStorage.removeItem('deliveries');
        localStorage.removeItem('currentSession');
        
        createDemoData();
        
        alert('‚úÖ Datos demo reseteados\n\nAhora puedes hacer login con:\nEmail: jefe@empresa.com\nPassword: 123456');
        
        // Recargar p√°gina
        location.reload();
    }
}

// Funci√≥n para crear datos demo
function createDemoData() {
    console.log('üì¶ Creando datos demo...');
        
        // Empresa demo
        const demoCompany = {
            id: 'company_demo_001',
            name: 'Transportes Demo SAC',
            ruc: '20123456789',
            plan: 'basico',
            created_at: new Date().toISOString()
        };
        
        localStorage.setItem('companies', JSON.stringify([demoCompany]));
        
        // Usuarios demo
        const demoUsers = [
            {
                id: 'user_001',
                email: 'jefe@empresa.com',
                password: '123456',
                role: 'jefe',
                companyId: 'company_demo_001',
                fullname: 'Jorge Garc√≠a',
                whatsapp: '51923190308', // Tu WhatsApp
                created_at: new Date().toISOString()
            },
            {
                id: 'user_002',
                email: 'repartidor@empresa.com',
                password: '123456',
                role: 'repartidor',
                companyId: 'company_demo_001',
                fullname: 'Repartidor Demo',
                whatsapp: '51923190308', // Tu WhatsApp
                created_at: new Date().toISOString()
            },
            {
                id: 'user_003',
                email: 'vendedor@empresa.com',
                password: '123456',
                role: 'vendedor',
                companyId: 'company_demo_001',
                fullname: 'Vendedor Demo',
                whatsapp: '51923190308',
                created_at: new Date().toISOString()
            },
            {
                id: 'user_004',
                email: 'contabilidad@empresa.com',
                password: '123456',
                role: 'contabilidad',
                companyId: 'company_demo_001',
                fullname: 'Contabilidad Demo',
                whatsapp: '51923190308',
                created_at: new Date().toISOString()
            }
        ];
        
        localStorage.setItem('users', JSON.stringify(demoUsers));
        
        // Clientes demo
        const demoClients = [
            {
                id: 'client_001',
                name: 'Juan P√©rez',
                dni: '12345678',
                phones: ['987654321'],
                email: 'juan.perez@gmail.com',
                addresses: ['Av. Principal 123, Mercado Central'],
                zone: 'Mercado Central',
                contacto: 'Juan P√©rez',
                referencia: 'Puesto 45, frente a la entrada principal'
            },
            {
                id: 'client_002',
                name: 'Mar√≠a Garc√≠a',
                dni: '23456789',
                phones: ['976543210'],
                email: 'maria.garcia@hotmail.com',
                addresses: ['Jr. Comercio 456, Gamarra'],
                zone: 'Gamarra',
                contacto: 'Mar√≠a Garc√≠a',
                referencia: 'Galer√≠a El Rosado, 2do piso, tienda 234'
            },
            {
                id: 'client_003',
                name: 'Carlos L√≥pez',
                dni: '34567890',
                phones: ['965432109'],
                email: 'carlos.lopez@outlook.com',
                addresses: ['Av. Los Olivos 789, Villa El Salvador'],
                zone: 'Villa El Salvador',
                contacto: 'Carlos L√≥pez',
                referencia: 'Casa amarilla, esquina con Jr. Los Pinos'
            },
            {
                id: 'client_004',
                name: 'Ana Rodr√≠guez',
                dni: '45678901',
                phones: ['954321098'],
                email: 'ana.rodriguez@gmail.com',
                addresses: ['Calle Las Flores 321, San Juan de Lurigancho'],
                zone: 'San Juan de Lurigancho',
                contacto: 'Ana Rodr√≠guez',
                referencia: 'Edificio Los Jardines, Dpto 301'
            },
            {
                id: 'client_005',
                name: 'Luis Mart√≠nez',
                dni: '56789012',
                phones: ['943210987'],
                email: 'luis.martinez@yahoo.com',
                addresses: ['Jr. Lima 654, Cercado de Lima'],
                zone: 'Cercado de Lima',
                contacto: 'Luis Mart√≠nez',
                referencia: 'Al lado del Banco de la Naci√≥n'
            },
            {
                id: 'client_006',
                name: 'Rosa S√°nchez',
                dni: '67890123',
                phones: ['932109876'],
                email: 'rosa.sanchez@gmail.com',
                addresses: ['Av. Per√∫ 890, Callao'],
                zone: 'Callao',
                contacto: 'Rosa S√°nchez',
                referencia: 'Bodega La Estrella, puerta verde'
            },
            {
                id: 'client_007',
                name: 'Pedro Torres',
                dni: '78901234',
                phones: ['921098765'],
                email: 'pedro.torres@hotmail.com',
                addresses: ['Jr. Cusco 234, La Victoria'],
                zone: 'La Victoria',
                contacto: 'Pedro Torres',
                referencia: 'Mercadillo Los Andes, puesto 89'
            },
            {
                id: 'client_008',
                name: 'Carmen Flores',
                dni: '89012345',
                phones: ['910987654'],
                email: 'carmen.flores@gmail.com',
                addresses: ['Av. Aviaci√≥n 567, San Borja'],
                zone: 'San Borja',
                contacto: 'Carmen Flores',
                referencia: 'Torre Empresarial, oficina 1205'
            },
            {
                id: 'client_009',
                name: 'Jorge Vargas',
                dni: '90123456',
                phones: ['909876543'],
                email: 'jorge.vargas@outlook.com',
                addresses: ['Calle Los Rosales 123, Surco'],
                zone: 'Surco',
                contacto: 'Jorge Vargas',
                referencia: 'Condominio Las Palmeras, casa 15'
            },
            {
                id: 'client_010',
                name: 'Patricia Ramos',
                dni: '01234567',
                phones: ['998765432'],
                email: 'patricia.ramos@gmail.com',
                addresses: ['Av. Universitaria 456, Los Olivos'],
                zone: 'Los Olivos',
                contacto: 'Patricia Ramos',
                referencia: 'Centro Comercial MegaPlaza, tienda 78'
            }
        ];
        
        localStorage.setItem('company_demo_001_clients', JSON.stringify(demoClients));
        
        // Entregas demo (historial)
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const twoDaysAgo = new Date(today);
        twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
        
        const demoDeliveries = [
            // Hoy
            {
                id: 'delivery_001',
                cliente: 'Juan P√©rez',
                zona: 'Mercado Central',
                guia: 'GU-2024-001',
                importeTotal: 450.00,
                montoPagado: 450.00,
                saldoPendiente: 0,
                tipoVenta: 'Contado',
                metodoPago: 'Efectivo',
                estadoPago: 'Pagado Completo',
                observaciones: 'Entrega sin novedad',
                fecha: today.toLocaleDateString('es-PE'),
                hora: '09:15:30',
                repartidor: 'Repartidor Demo'
            },
            {
                id: 'delivery_002',
                cliente: 'Rosa S√°nchez',
                zona: 'Callao',
                guia: 'GU-2024-002',
                importeTotal: 680.00,
                montoPagado: 680.00,
                saldoPendiente: 0,
                tipoVenta: 'Contado',
                metodoPago: 'Yape',
                estadoPago: 'Pagado Completo',
                observaciones: 'Cliente satisfecho',
                fecha: today.toLocaleDateString('es-PE'),
                hora: '10:30:15',
                repartidor: 'Repartidor Demo'
            },
            {
                id: 'delivery_003',
                cliente: 'Carmen Flores',
                zona: 'San Borja',
                guia: 'GU-2024-003',
                importeTotal: 1200.00,
                montoPagado: 0,
                saldoPendiente: 1200.00,
                tipoVenta: 'Cr√©dito',
                metodoPago: 'Cr√©dito',
                estadoPago: 'Pendiente (Cr√©dito)',
                observaciones: 'Pago programado para el 30',
                fecha: today.toLocaleDateString('es-PE'),
                hora: '11:45:20',
                repartidor: 'Repartidor Demo'
            },
            // Ayer
            {
                id: 'delivery_004',
                cliente: 'Mar√≠a Garc√≠a',
                zona: 'Gamarra',
                guia: 'GU-2024-004',
                importeTotal: 890.00,
                montoPagado: 500.00,
                saldoPendiente: 390.00,
                tipoVenta: 'Contado',
                metodoPago: 'Efectivo',
                estadoPago: 'Pago Parcial',
                observaciones: 'Pag√≥ S/. 500, saldo para ma√±ana',
                fecha: yesterday.toLocaleDateString('es-PE'),
                hora: '08:20:10',
                repartidor: 'Repartidor Demo'
            },
            {
                id: 'delivery_005',
                cliente: 'Pedro Torres',
                zona: 'La Victoria',
                guia: 'GU-2024-005',
                importeTotal: 320.00,
                montoPagado: 320.00,
                saldoPendiente: 0,
                tipoVenta: 'Contado',
                metodoPago: 'Plin',
                estadoPago: 'Pagado Completo',
                observaciones: '',
                fecha: yesterday.toLocaleDateString('es-PE'),
                hora: '14:10:45',
                repartidor: 'Repartidor Demo'
            },
            {
                id: 'delivery_006',
                cliente: 'Jorge Vargas',
                zona: 'Surco',
                guia: 'GU-2024-006',
                importeTotal: 1500.00,
                montoPagado: 1500.00,
                saldoPendiente: 0,
                tipoVenta: 'Contado',
                metodoPago: 'Yape',
                estadoPago: 'Pagado Completo',
                observaciones: 'Pedido urgente, entregado a tiempo',
                fecha: yesterday.toLocaleDateString('es-PE'),
                hora: '16:30:00',
                repartidor: 'Repartidor Demo'
            },
            // Hace 2 d√≠as
            {
                id: 'delivery_007',
                cliente: 'Carlos L√≥pez',
                zona: 'Villa El Salvador',
                guia: 'GU-2024-007',
                importeTotal: 750.00,
                montoPagado: 750.00,
                saldoPendiente: 0,
                tipoVenta: 'Contado',
                metodoPago: 'Efectivo',
                estadoPago: 'Pagado Completo',
                observaciones: '',
                fecha: twoDaysAgo.toLocaleDateString('es-PE'),
                hora: '09:00:00',
                repartidor: 'Repartidor Demo'
            },
            {
                id: 'delivery_008',
                cliente: 'Ana Rodr√≠guez',
                zona: 'San Juan de Lurigancho',
                guia: 'GU-2024-008',
                importeTotal: 420.00,
                montoPagado: 420.00,
                saldoPendiente: 0,
                tipoVenta: 'Contado',
                metodoPago: 'Efectivo',
                estadoPago: 'Pagado Completo',
                observaciones: 'Entrega en edificio',
                fecha: twoDaysAgo.toLocaleDateString('es-PE'),
                hora: '11:15:30',
                repartidor: 'Repartidor Demo'
            }
        ];
        
        localStorage.setItem('deliveries', JSON.stringify(demoDeliveries));
        
        console.log('‚úÖ Datos demo inicializados:');
        console.log('   - 1 empresa');
        console.log('   - 3 usuarios (jefe, repartidor, vendedor)');
        console.log('   - 10 clientes');
        console.log('   - 8 entregas de ejemplo');
        console.log('');
        console.log('üìù Credenciales de acceso:');
        console.log('   Jefe: jefe@empresa.com / 123456');
        console.log('   Repartidor: repartidor@empresa.com / 123456');
        console.log('   Vendedor: vendedor@empresa.com / 123456');
}

// Cargar configuraci√≥n guardada
function loadWhatsAppConfig() {
    const savedNumber = localStorage.getItem('whatsapp_group_number');
    if (savedNumber) {
        WHATSAPP_CONFIG.groupNumber = savedNumber;
    }
}

// ============================================
// INICIALIZAR APLICACI√ìN
// ============================================
// Cargar datos demo
initializeDemoData();

// Cargar config WhatsApp
loadWhatsAppConfig();

console.log('üöÄ Sistema de Reparto iniciado');
console.log('üì± Para probar: Login como jefe@empresa.com / 123456');




</script>

</body>
</html>